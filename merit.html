<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merit — High Peak & Marple Snooker League</title>
<link rel="icon" type="image/png" href="/logo.PNG" sizes="192x192">
<link rel="apple-touch-icon" href="/logo.PNG">
<link rel="preload" as="image" href="/logo.PNG">
<link rel="stylesheet" href="style.css" />
<style>
  :root{
    --brand-green:#002b19; --banner-height:140px; --page-max:1100px; --accent:#19d36b;
    --bar-dark:#1f1f1f; --bar-border:#2a2a2a; --overlay-bg:rgba(15,17,22,.85);

    /* base widths (JS will auto-fit --w-week) */
    --w-name:220px; --w-team:180px; --w-hcp:62px;
    --w-week:40px;  /* will be resized dynamically */
    --w-pwl:44px; --w-diff:54px; --w-25:52px; --w-hi:88px;
    --grid-font:.92rem;

    /* density */
    --cell-pad-y:5px; --cell-pad-x:6px;
  }
  html,body{margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f8fb;color:#0b1220}
  .container{max-width:var(--page-max);margin:0 auto;padding:0 12px}
  .container.wide{max-width:1600px}

  /* Crest banner */
  header.logo-header{background:var(--brand-green);box-shadow:0 2px 10px rgba(0,0,0,.25);height:var(--banner-height);display:flex;align-items:center;justify-content:center}
  .logo-banner{height:100%;display:flex;align-items:center;justify-content:center}
  .logo-banner img{height:100%;width:auto;object-fit:contain;display:block;filter:drop-shadow(0 0 6px rgba(0,0,0,.4))}

  /* Announcement */
  #announcement-banner{position:sticky;top:0;z-index:100;display:none;background:var(--bar-dark);color:#fff;font-weight:600;font-size:.85rem;padding:.35rem 0;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid var(--bar-border)}
  #announcement-inner{max-width:var(--page-max);margin:0 auto;padding:0 12px;text-align:center}

  /* Menu */
  .menu-bar{background:var(--bar-dark);padding:8px 0 10px;position:relative;z-index:110;border-bottom:1px solid var(--bar-border)}
  .menu-inner{max-width:var(--page-max);margin:0 auto;padding:0 12px;position:relative}
  .menu-inner.wide{max-width:1600px}
  .menu-toggle{width:100%;background:var(--bar-dark);color:#fff;padding:10px 12px;border:1px solid var(--bar-border);border-radius:10px;font-weight:800;font-size:1rem;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.25) inset}
  .menu-toggle:focus-visible{outline:3px solid var(--accent);outline-offset:2px}
  nav.site-nav{position:absolute;left:12px;right:12px;top:calc(100% + 6px);background:var(--overlay-bg);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:10px;box-shadow:0 18px 36px rgba(0,0,0,.45);padding:6px;z-index:120}
  [hidden]{display:none!important}
  nav.site-nav a{display:block;color:#e5e7eb;text-decoration:none;font-weight:700;padding:10px 10px;border-radius:8px}
  nav.site-nav a:hover{background:rgba(255,255,255,.1)}
  nav.site-nav a.active{background:var(--accent);color:#0b1b0f}

  /* Page */
  main.container{background:#fff;padding:1rem 12px 1.2rem;border-radius:10px;margin-top:10px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  h2{margin:.25rem 0 .4rem 0}
  .legend{margin:.25rem 0 .6rem 0;color:#475569;font-size:.95rem}

  /* Controls row */
  .controls{display:flex;flex-wrap:wrap;gap:.5rem;margin:.4rem 0 .85rem}
  .controls .ctl{display:inline-flex;align-items:center;gap:.45rem;background:#eef1f5;border:1px solid #dde2ea;border-radius:8px;padding:.35rem .55rem;font-weight:700}
  .controls .ctl input[type=checkbox]{transform:scale(1.1)}
  .controls .btn{cursor:pointer;border:none;background:#eef1f5;border:1px solid #dde2ea;border-radius:8px;padding:.35rem .65rem;font-weight:800}
  .controls .btn.active{background:var(--accent);color:#0b1b0f;border-color:#0b1b0f}

  /* View tabs */
  .view-tabs{display:flex;gap:.4rem;margin:.25rem 0 .6rem}
  .view-tabs .view-btn{margin:0;padding:.4em .8em;border:none;border-radius:8px;font-weight:800;cursor:pointer;background:#eef1f5}
  .view-tabs .view-btn.active{background:var(--accent);color:#0b1b0f}

  /* Team filter tabs */
  .tabs{display:flex;flex-wrap:wrap;gap:.35rem;margin:.25rem 0 .6rem}
  .tab-btn{margin:0;padding:.35em .7em;border:none;border-radius:6px;font-weight:700;cursor:pointer;color:#000}
  .tab-btn.active{box-shadow:0 0 0 2px #333 inset}

  /* Team colour bands */
  tr.team-color-0{background-color:#e6f4ff}
  tr.team-color-1{background-color:#e6ffe6}
  tr.team-color-2{background-color:#fff0e6}
  tr.team-color-3{background-color:#f9e6ff}
  tr.team-color-4{background-color:#fffde6}
  tr.team-color-5{background-color:#f0f0ff}
  tr.team-color-6{background-color:#e6fff2}
  tr.team-color-7{background-color:#ffe6f0}
  tr.team-color-8{background-color:#f6f6f6}
  tr.team-color-9{background-color:#e0f7fa}
  .tab-btn.color-0{background:#cce8ff}.tab-btn.color-1{background:#bfffbf}.tab-btn.color-2{background:#ffd4b3}.tab-btn.color-3{background:#ebccff}.tab-btn.color-4{background:#fff9b3}.tab-btn.color-5{background:#d6d6ff}.tab-btn.color-6{background:#b3ffe0}.tab-btn.color-7{background:#ffcce0}.tab-btn.color-8{background:#dddddd}.tab-btn.color-9{background:#b2ebf2}

  /* Tables */
  .table-scroller{overflow-x:auto;-webkit-overflow-scrolling:touch;position:relative}
  table.grid{width:100%;border-collapse:separate;border-spacing:0;background:#fff;font-size:var(--grid-font);table-layout:fixed}
  table.grid th,table.grid td{border:1px solid #e4e4e4;padding:var(--cell-pad-y) var(--cell-pad-x);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  table.grid thead th{background:#f0f0f0;font-weight:700}

  /* Sticky cols for Merit */
  #playersGrid th.sticky,   #playersGrid td.sticky   { position:sticky; left:var(--s0,0px); z-index:2; background:inherit }
  #playersGrid th.sticky-2, #playersGrid td.sticky-2{ position:sticky; left:var(--s1,0px); z-index:2; background:inherit }
  #playersGrid th.sticky-3, #playersGrid td.sticky-3{ position:sticky; left:var(--s2,0px); z-index:2; background:inherit }
  #playersGrid td.sticky,#playersGrid td.sticky-2,#playersGrid td.sticky-3{box-shadow:2px 0 0 rgba(0,0,0,.05)}

  .col-name,.col-team{text-align:left;line-height:1.15}
  .col-name{min-width:var(--w-name);font-size:.9em}
  .col-team{min-width:var(--w-team);font-size:.88em}
  .col-hcp{width:var(--w-hcp)}
  .col-week{width:var(--w-week);min-width:var(--w-week);font-variant-numeric:tabular-nums}
  .col-p,.col-w,.col-l{width:var(--w-pwl)}
  .col-diff{width:var(--w-diff)}
  .col-25{width:var(--w-25)}
  .col-hi{width:var(--w-hi)}

  .cell-w{background:#19c67a;color:#083;font-weight:700}
  .cell-l{background:#f6903d;color:#5a2a00;font-weight:700}
  .cell-na{background:#111;color:#fff}
  .cell-blank{background:#fff}

  /* Handicaps table (separate view) */
  #handicapsGrid th.sticky,   #handicapsGrid td.sticky   { position:sticky; left:0; z-index:2; background:inherit }
  #handicapsGrid th.sticky-2, #handicapsGrid td.sticky-2{ position:sticky; left:var(--h1,240px); z-index:2; background:inherit }
  #handicapsGrid th.sticky-3, #handicapsGrid td.sticky-3{ position:sticky; left:var(--h2,420px); z-index:2; background:inherit }

  /* Handicap visuals */
  .sub{display:block;font-size:.75em;color:#64748b;font-weight:600}
  .hcp-now{font-weight:800}
  .delta{display:inline-block;min-width:2.2ch;padding:.05rem .35rem;border-radius:999px;font-size:.78em;font-weight:800;vertical-align:baseline;margin-left:.35rem}
  .delta.up{background:#e7f7ef;color:#0a7a2a;border:1px solid #bfead1}
  .delta.down{background:#fde8e8;color:#a32020;border:1px solid #f5bebe}
  .delta.flat{background:#eef1f5;color:#444;border:1px solid #dde2ea}

  /* Links */
  a.player-link{color:#0b5; font-weight:700; text-decoration:none}
  a.player-link:hover, a.player-link:focus{ text-decoration:underline; outline:none }

  footer{text-align:center;padding:1.2rem 1rem;color:#777}

  /* Compact mode */
  .compact table.grid{font-size:.86rem}
  .compact :root, .compact{--cell-pad-y:3px; --cell-pad-x:5px}
  .compact .col-name{min-width:190px}
  .compact .col-team{min-width:150px}

  /* Mobile tweaks */
  @media (max-width:480px){
    :root{
      --banner-height:110px;
      --w-name:160px; --w-team:128px; --w-hcp:54px;
      --w-week:30px; --w-pwl:36px; --w-diff:46px; --w-25:42px; --w-hi:70px;
      --grid-font:.84rem;
    }
    table.grid th,table.grid td{padding:4px 5px}
    .col-name{font-size:.8em}
    .col-team{font-size:.78em}
  }
</style>
</head>
<body>
<header class="logo-header" role="banner">
  <div class="logo-banner">
    <img src="logo.PNG?v=18" alt="High Peak &amp; Marple Snooker League crest">
  </div>
</header>

<div id="announcement-banner" role="status" aria-live="polite">
  <div id="announcement-inner" class="container">
    <span id="announcement-text"></span>
  </div>
</div>

<div class="menu-bar">
  <div class="menu-inner" id="menuContainer">
    <button class="menu-toggle" id="menuToggle" aria-expanded="false" aria-controls="siteNav">☰ Menu</button>
    <nav id="siteNav" class="site-nav" hidden>
      <a href="index.html">Home</a>
      <a href="fixtures.html">Fixtures</a>
      <a href="results.html">Results</a>
      <a href="merit.html" class="active">Merit</a>
      <a href="venues.html">Venues</a>
      <a href="rules.html">Rules</a>
      <a href="history.html">Honours List</a>
      <a href="archive.html">Archive</a>
    </nav>
  </div>
</div>

<main class="container" id="pageContainer">
  <h2>Merit</h2>
  <p class="legend">
    <strong>Merit table uses each player’s <em>current handicap</em> (HCP)</strong>.  
    The new <strong>Handicaps</strong> tab lists all players whose handicap changed, with start → now → Δ.
  </p>

  <div class="controls" aria-label="Display options">
    <button type="button" class="btn" id="btnWide" title="Wider table">Wider table</button>
    <button type="button" class="btn" id="btnDensity" title="Compact rows">Compact rows</button>
    <label class="ctl" title="Auto-fit week columns to available width">
      <input type="checkbox" id="chkAutoFit" checked> Auto-fit week columns
    </label>
  </div>

  <div class="view-tabs">
    <button class="view-btn active" data-view="merit">Merit Table</button>
    <button class="view-btn" data-view="handicaps">Handicaps</button>
    <button class="view-btn" data-view="breaks">Breaks</button>
  </div>

  <!-- MERIT VIEW -->
  <section id="view-merit">
    <div class="tabs" id="teamTabsMerit"></div>
    <div class="table-scroller">
      <table id="playersGrid" class="grid" aria-describedby="meritHeatmap"></table>
    </div>
    <p id="meritHeatmap" class="visually-hidden">Player weekly results grid with wins/losses by week (W1..W18) and totals.</p>
  </section>

  <!-- HANDICAPS VIEW -->
  <section id="view-handicaps" hidden>
    <div class="tabs" id="teamTabsHcp"></div>
    <div class="table-scroller">
      <table id="handicapsGrid" class="grid"></table>
    </div>
  </section>

  <!-- BREAKS VIEW -->
  <section id="view-breaks" hidden>
    <div class="table-scroller">
      <table class="grid" id="breaksTable">
        <thead>
          <tr>
            <th style="min-width:220px;text-align:left">Player</th>
            <th style="min-width:160px;text-align:left">Team</th>
            <th style="width:70px">25+</th>
            <th style="width:90px">High</th>
            <th>Breaks</th>
          </tr>
        </thead>
        <tbody id="breaksBody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer>&copy; 2025 High Peak &amp; Marple Snooker League</footer>

<!-- Menu logic -->
<script>
  (function(){
    const btn=document.getElementById('menuToggle');
    const nav=document.getElementById('siteNav');
    function closeNav(){nav.hidden=true;btn.setAttribute('aria-expanded','false')}
    btn.addEventListener('click',()=>{
      const ex=btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded',String(!ex));
      nav.hidden=ex;
    });
    document.addEventListener('click',(e)=>{
      if(!nav.hidden && !nav.contains(e.target) && e.target!==btn && !btn.contains(e.target)){ closeNav(); }
    });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeNav(); });
  })();
</script>

<!-- Announcement -->
<script>
  fetch('data/announcement.json',{cache:'no-store'})
    .then(r=>r.json())
    .then(d=>{
      if(d && d.message && d.message.trim()){
        document.getElementById('announcement-text').textContent=d.message.trim();
        document.getElementById('announcement-banner').style.display='block';
      }
    })
    .catch(()=>{});
</script>

<!-- Main logic -->
<script>
(async function () {
  const WEEK_MAX = 18;

  const [teams, players, fixtures, matches] = await Promise.all([
    fetch('data/teams.json',{cache:'no-store'}).then(r=>r.json()),
    fetch('data/players.json',{cache:'no-store'}).then(r=>r.json()),
    fetch('data/fixtures.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>[]),
    fetch('data/matches.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>[])
  ]);

  const pageContainer = document.getElementById('pageContainer');
  const menuContainer = document.getElementById('menuContainer');

  /* === Controls === */
  const btnWide = document.getElementById('btnWide');
  const btnDensity = document.getElementById('btnDensity');
  const chkAuto = document.getElementById('chkAutoFit');

  function setWide(on){
    pageContainer.classList.toggle('wide', on);
    menuContainer.classList.toggle('wide', on);
    localStorage.setItem('playersWideMode', on ? '1' : '0');
    btnWide.classList.toggle('active', on);
    computeStickyOffsetsMerit();
    if (chkAuto.checked) fitWeeks();
  }
  function setDensity(compact){
    document.body.classList.toggle('compact', compact);
    localStorage.setItem('playersCompactMode', compact ? '1' : '0');
    btnDensity.classList.toggle('active', compact);
    computeStickyOffsetsMerit();
    if (chkAuto.checked) fitWeeks();
  }

  setWide(localStorage.getItem('playersWideMode') === '1');
  setDensity(localStorage.getItem('playersCompactMode') === '1');

  btnWide.addEventListener('click', ()=> setWide(!btnWide.classList.contains('active')));
  btnDensity.addEventListener('click', ()=> setDensity(!btnDensity.classList.contains('active')));

  /* === Basic maps === */
  const teamById = Object.fromEntries(teams.map(t => [t.id, t]));
  const playerById = Object.fromEntries(players.map(p => [p.id, p]));
  const teamColorClass = {}; teams.forEach((t,i)=> teamColorClass[t.id] = i % 10);

  /* === Helpers === */
  function isComplete(m){
    if (!m) return false;
    if (m.status === 'postponed' || m.status === 'void') return true;
    if (typeof m.homeFrames === 'number' && typeof m.awayFrames === 'number') return true;
    if (Array.isArray(m.frames) && m.frames.some(fr => fr.winner==='home' || fr.winner==='away')) return true;
    return false;
  }
  function escapeHtml(s=''){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
  function toBreakList(x){
    if (!x) return [];
    const arr = Array.isArray(x) ? x : (typeof x === 'number' ? [x] : []);
    return arr.filter(n=>typeof n==='number');
  }

  /* === Dates / weeks === */
  const completedMatches = matches.filter(isComplete);
  const dateSet = new Set(completedMatches.map(m => m.date));
  const confirmedDatesAll = Array.from(dateSet).sort((a,b)=>new Date(a)-new Date(b));
  const weekDates = confirmedDatesAll.slice(0, WEEK_MAX);

  const teamHasFixture = {};
  for (const d of weekDates){ teamHasFixture[d] = {}; teams.forEach(t=>teamHasFixture[d][t.id]=false); }
  completedMatches.forEach(m=>{ if(teamHasFixture[m.date]){ teamHasFixture[m.date][m.homeTeamId]=true; teamHasFixture[m.date][m.awayTeamId]=true; }});
  fixtures.forEach(f=>{ if(teamHasFixture[f.date]){ teamHasFixture[f.date][f.homeTeamId]=true; teamHasFixture[f.date][f.awayTeamId]=true; }});

  /* === Build player rows === */
  const P = {};
  const breaksByPlayer = {};
  players.forEach(p=>{
    const currentHcp  = (p.HCP ?? p.hcp ?? p.handicap ?? 0);
    const startingHcp = (p.startHCP ?? p.startHcp ?? p.startingHcp ?? currentHcp ?? 0);

    P[p.id] = {
      id:p.id, name:p.name, teamId:p.teamId,
      teamName:teamById[p.teamId]?.name || '',
      HCP: currentHcp,
      Start: startingHcp,
      perDate: Object.fromEntries(weekDates.map(d=>[d,'blank'])),
      totals: { played:0, won:0, lost:0, diff:0, break25:0, high:0, winPct:0 }
    };
    breaksByPlayer[p.id] = { name:p.name, teamName:teamById[p.teamId]?.name || '', list:[], high:0 };
  });

  if (weekDates.length){
    for (const p of players){
      for (const d of weekDates){
        if (!teamHasFixture[d][p.teamId]) P[p.id].perDate[d] = 'na';
      }
    }
  }

  function recordFrame(frame, isHome, date){
    if (!weekDates.includes(date)) return;
    const pid = isHome ? frame.homePlayerId : frame.awayPlayerId;
    const row = P[pid];
    if (!row) return;

    if (row.perDate[date] !== 'na'){
      const win = frame.winner === 'home' ? isHome : frame.winner === 'away' ? !isHome : null;
      if (win === true){ row.perDate[date] = 'W'; row.totals.played++; row.totals.won++; }
      else if (win === false){ row.perDate[date] = 'L'; row.totals.played++; row.totals.lost++; }
    }

    const mine = isHome ? frame?.breaks?.home : frame?.breaks?.away;
    const plus25 = toBreakList(mine).filter(n=>n>=25);
    if (plus25.length){
      row.totals.break25 += plus25.length;
      row.totals.high = Math.max(row.totals.high, ...plus25);
      breaksByPlayer[pid].list.push(...plus25);
      breaksByPlayer[pid].high = Math.max(breaksByPlayer[pid].high, ...plus25);
    }
  }
  completedMatches.forEach(m=>{
    if (!Array.isArray(m.frames)) return;
    m.frames.forEach(fr=>{
      recordFrame(fr, true,  m.date);
      recordFrame(fr, false, m.date);
    });
  });

  Object.values(P).forEach(r=>{
    r.totals.diff = r.totals.won - r.totals.lost;
    r.totals.winPct = r.totals.played ? (r.totals.won / r.totals.played) : 0;
  });

  const leagueHigh = Math.max(0, ...Object.values(P).map(r => r.totals.high || 0));

  function sortRows(rows){
    return rows.sort((a,b)=>{
      if (b.totals.won !== a.totals.won) return b.totals.won - a.totals.won;
      if (a.totals.played !== b.totals.played) return a.totals.played - b.totals.played;
      const ah=a.totals.high||0, bh=b.totals.high||0;
      if (bh!==ah) return bh-ah;
      return a.name.localeCompare(b.name);
    });
  }

  /* ========== MERIT TABLE RENDER ========== */
  function autoFitWeekWidth(tbl, weeksCount){
    const scroller = tbl.parentElement;
    const visible = scroller.clientWidth || scroller.getBoundingClientRect().width || 0;
    if (!visible) return;
    tbl.style.setProperty('--w-week','32px');

    const head = tbl.querySelector('thead tr');
    if (!head) return;

    let fixedW = 0;
    head.childNodes.forEach((th, idx)=>{
      // 3 fixed columns: Name, Team, HCP (Now)
      if (idx < 3 || idx >= 3 + weeksCount) { fixedW += th.offsetWidth || 0; }
    });

    const gutter = 8;
    const spaceForWeeks = Math.max(0, visible - fixedW - gutter);
    const minW = 18, maxW = 46;
    const perWeek = Math.floor(spaceForWeeks / Math.max(weeksCount,1));
    const target = Math.max(minW, Math.min(maxW, perWeek));
    tbl.style.setProperty('--w-week', target + 'px');
  }
  function computeStickyOffsetsMerit(){
    const tbl = document.getElementById('playersGrid');
    if (!tbl) return;
    const head = tbl.querySelector('thead tr');
    const row  = tbl.querySelector('tbody tr');

    const w = i =>
      (head?.children[i]?.getBoundingClientRect().width) ||
      (row ?.children[i]?.getBoundingClientRect().width) || 0;

    const w0 = w(0), w1 = w(1);
    tbl.style.setProperty('--s0','0px');
    tbl.style.setProperty('--s1', w0 + 'px');
    tbl.style.setProperty('--s2', (w0 + w1) + 'px');
  }
  function fitWeeks(){
    const tbl=document.getElementById('playersGrid');
    if (!tbl) return;
    const weeksCount = tbl.querySelectorAll('thead th.col-week').length;
    autoFitWeekWidth(tbl, weeksCount);
  }

  const tabsMerit = document.getElementById('teamTabsMerit');
  const ALL='__all__';
  function mkBtn(id,label,colorClass, onClick){
    const b=document.createElement('button');
    b.type='button';
    b.className='tab-btn'+(colorClass!==null?` color-${colorClass}`:'');
    b.dataset.teamId=id;
    b.textContent=label;
    b.addEventListener('click',()=>{
      [...b.parentElement.children].forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      onClick(id);
    });
    return b;
  }

  function renderMerit(teamFilter){
    const tbl = document.getElementById('playersGrid');

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    trh.innerHTML =
      `<th class="sticky col-name">Name</th>
       <th class="sticky-2 col-team">Team</th>
       <th class="sticky-3 col-hcp">HCP</th>`;

    weekDates.forEach((d, i)=>{
      const dt = new Date(d);
      const ddmmyyLong = isNaN(dt) ? d : dt.toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'});
      const th=document.createElement('th');
      th.className='col-week';
      th.title = ddmmyyLong;
      th.textContent = 'W' + (i+1);
      trh.appendChild(th);
    });

    [['P','col-p'],['W','col-w'],['L','col-l'],['+/-','col-diff'],['25+','col-25'],['High Break','col-hi']]
      .forEach(([label,cls])=>{
        const th=document.createElement('th'); th.textContent=label; th.className=cls; trh.appendChild(th);
      });

    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    let rows = Object.values(P);
    rows = (!teamFilter || teamFilter === ALL) ? rows.filter(r => r.totals.played > 0)
                                              : rows.filter(r => r.teamId === teamFilter && r.totals.played > 0);
    rows = sortRows(rows);

    rows.forEach(r=>{
      const isHighHolder = (r.totals.high||0)>0 && (r.totals.high === leagueHigh);
      const star = isHighHolder ? ' <span class="star" aria-label="High break holder" title="High break holder">⭐</span>' : '';

      const tr = document.createElement('tr');
      tr.className = `team-color-${teamColorClass[r.teamId] ?? 0}`;

      const nameCell = `<a href="#" class="player-link" data-id="${r.id}" title="View full results">${escapeHtml(r.name)}${star}</a>`;
      tr.innerHTML =
       `<td class="sticky col-name">${nameCell}</td>
        <td class="sticky-2 col-team">${escapeHtml(r.teamName)}</td>
        <td class="sticky-3 col-hcp">${r.HCP}</td>`;

      weekDates.forEach(d=>{
        const v = r.perDate[d];
        let cls='cell-blank', text='';
        if (v==='W') { cls='cell-w'; text='W'; }
        else if (v==='L') { cls='cell-l'; text='L'; }
        else if (v==='na'){ cls='cell-na'; }
        const td=document.createElement('td'); td.className=`col-week ${cls}`; td.textContent=text; tr.appendChild(td);
      });

      const T=r.totals;
      tr.insertAdjacentHTML('beforeend',
        `<td class="col-p">${T.played}</td>
         <td class="col-w">${T.won}</td>
         <td class="col-l">${T.lost}</td>
         <td class="col-diff">${T.diff}</td>
         <td class="col-25">${T.break25}</td>
         <td class="col-hi">${T.high || 0}</td>`);
      tbody.appendChild(tr);
    });

    tbl.replaceChildren(thead, tbody);

    computeStickyOffsetsMerit();
    if (chkAuto.checked) fitWeeks();
  }

  // Merit team tabs
  (function initMeritTabs(){
    const tabs = tabsMerit;
    tabs.innerHTML = '';
    tabs.appendChild(mkBtn(ALL,'All Teams',null,(id)=>{ localStorage.setItem('playersTeamFilter',id); renderMerit(id); }));
    teams.forEach(t=> tabs.appendChild(mkBtn(t.id,t.name,teamColorClass[t.id],(id)=>{ localStorage.setItem('playersTeamFilter',id); renderMerit(id); })));
    const urlTeam=new URLSearchParams(location.search).get('team');
    const stored=localStorage.getItem('playersTeamFilter');
    const startId=(urlTeam&&teamById[urlTeam])?urlTeam:(stored&&teamById[stored]?stored:ALL);
    const startBtn=[...tabs.children].find(b=>b.dataset.teamId===startId)||tabs.firstChild;
    startBtn.classList.add('active');
    renderMerit(startId);
  })();

  /* ========== HANDICAPS VIEW RENDER ========== */
  function renderHandicaps(teamFilter){
    const tbl = document.getElementById('handicapsGrid');

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    trh.innerHTML =
      `<th class="sticky" style="min-width:220px;text-align:left">Name</th>
       <th class="sticky-2" style="min-width:180px;text-align:left">Team</th>
       <th class="sticky-3" style="width:90px">Start</th>
       <th style="width:90px">HCP (Now)</th>
       <th style="width:90px">Δ</th>`;
    thead.appendChild(trh);

    const tbody = document.createElement('tbody');

    let rows = Object.values(P)
      .filter(r => r.HCP !== r.Start); // only changed handicaps

    rows = (!teamFilter || teamFilter === ALL) ? rows
                                              : rows.filter(r => r.teamId === teamFilter);

    // Sort by magnitude of change, then name
    rows.sort((a,b)=>{
      const da = Math.abs(a.HCP - a.Start);
      const db = Math.abs(b.HCP - b.Start);
      if (db!==da) return db-da;
      return a.name.localeCompare(b.name);
    });

    rows.forEach(r=>{
      const delta = r.HCP - r.Start;
      const deltaTxt = (delta>0?'+':'') + delta;
      const deltaClass = delta>0?'up':(delta<0?'down':'flat');

      const tr = document.createElement('tr');
      tr.className = `team-color-${teamColorClass[r.teamId] ?? 0}`;
      tr.innerHTML =
        `<td class="sticky" style="text-align:left"><a href="#" class="player-link" data-id="${r.id}" title="View full results">${escapeHtml(r.name)}</a></td>
         <td class="sticky-2" style="text-align:left">${escapeHtml(r.teamName)}</td>
         <td class="sticky-3">${r.Start}</td>
         <td class="hcp-now">${r.HCP}</td>
         <td><span class="delta ${deltaClass}" title="Change since start">${deltaTxt}</span></td>`;
      tbody.appendChild(tr);
    });

    tbl.replaceChildren(thead, tbody);

    // Sticky offsets for first three columns in Handicaps table
    const head = tbl.querySelector('thead tr');
    const row  = tbl.querySelector('tbody tr');
    const w = i =>
      (head?.children[i]?.getBoundingClientRect().width) ||
      (row ?.children[i]?.getBoundingClientRect().width) || 0;
    tbl.style.setProperty('--h1', (w(0)) + 'px');
    tbl.style.setProperty('--h2', (w(0)+w(1)) + 'px');
  }

  // Handicaps team tabs
  (function initHcpTabs(){
    const tabs = document.getElementById('teamTabsHcp');
    tabs.innerHTML = '';
    tabs.appendChild(mkBtn(ALL,'All Teams',null,(id)=>{ localStorage.setItem('hcpTeamFilter',id); renderHandicaps(id); }));
    teams.forEach(t=> tabs.appendChild(mkBtn(t.id,t.name,teamColorClass[t.id],(id)=>{ localStorage.setItem('hcpTeamFilter',id); renderHandicaps(id); })));
    const stored=localStorage.getItem('hcpTeamFilter') || ALL;
    const startBtn=[...tabs.children].find(b=>b.dataset.teamId===stored)||tabs.firstChild;
    startBtn.classList.add('active');
    renderHandicaps(stored);
  })();

  /* ========== BREAKS VIEW ========== */
  function renderBreaks(){
    const body = document.getElementById('breaksBody');
    body.innerHTML = '';

    const seriesHigh = Math.max(0, ...Object.values(breaksByPlayer).map(b => b.high || 0));
    const rows = Object.entries(breaksByPlayer)
      .map(([pid,info])=>{
        const list = [...info.list].sort((a,b)=>b-a);
        return { pid, name:info.name, team:info.teamName, count:list.length, high:list[0]||0, list };
      })
      .filter(r=>r.count>0)
      .sort((a,b)=> (b.high-a.high)||(b.count-a.count)||a.name.localeCompare(b.name));

    rows.forEach(r=>{
      const isHigh = r.high === seriesHigh && seriesHigh>0;
      const star = isHigh ? ' <span class="star" aria-hidden="true">⭐</span>' : '';
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:left;min-width:220px">${escapeHtml(r.name)}${star}</td>
        <td style="text-align:left;min-width:160px">${escapeHtml(r.team)}</td>
        <td style="text-align:center">${r.count}</td>
        <td style="text-align:center">${r.high}${isHigh ? ' ⭐' : ''}</td>
        <td>${r.list.join(' · ')}</td>`;
      body.appendChild(tr);
    });
  }
  renderBreaks();

  /* ========== Player detail (click from any table) ========== */
  function formatDate(d){
    if(!d) return '';
    const dt = new Date(d);
    if (isNaN(dt)) return d;
    return dt.toLocaleDateString('en-GB',{weekday:'short', day:'2-digit', month:'short', year:'numeric'});
  }
  function listBreaks(b){
    if(!b) return '';
    const arr = Array.isArray(b) ? b : (typeof b==='number' ? [b] : []);
    const plus = arr.filter(n=>typeof n==='number' && n>=0);
    return plus.join(' · ');
  }

  function showPlayerDetail(playerId){
    const section = document.getElementById('view-merit'); // keep focus on main section
    const detail = document.createElement('div'); // lightweight modal-ish table
    detail.id='playerDetailTemp';
    detail.style.marginTop='1rem';

    // rows
    const rows = [];
    for(const m of matches){
      const frames = Array.isArray(m.frames) ? m.frames : [];
      for(const fr of frames){
        const isHome = fr.homePlayerId === playerId;
        const isAway = fr.awayPlayerId === playerId;
        if(!(isHome || isAway)) continue;

        const oppId = isHome ? fr.awayPlayerId : fr.homePlayerId;
        const opp = playerById[oppId];
        const oppTeamId = isHome ? m.awayTeamId : m.homeTeamId;
        const oppTeam = teamById[oppTeamId]?.name || oppTeamId;

        const youAreHome = isHome;
        const yourPts = (youAreHome ? fr.homePoints : fr.awayPoints);
        const oppPts  = (youAreHome ? fr.awayPoints : fr.homePoints);
        const hasPts = Number.isFinite(yourPts) && Number.isFinite(oppPts);

        const youWon = fr.winner === (youAreHome ? 'home' : 'away');
        const result = youWon ? 'W' : 'L';

        const myBreaks = youAreHome ? fr?.breaks?.home : fr?.breaks?.away;

        rows.push({
          date: m.date,
          fixture: `${teamById[m.homeTeamId]?.name || m.homeTeamId} vs ${teamById[m.awayTeamId]?.name || m.awayTeamId}`,
          hoa: youAreHome ? 'Home' : 'Away',
          opponent: opp?.name || '—',
          oppTeam,
          score: hasPts ? `${yourPts}–${oppPts}` : '—',
          result,
          breaks: listBreaks(myBreaks)
        });
      }
    }

    rows.sort((a,b)=> a.date.localeCompare(b.date));

    const html = `
      <div style="border:1px solid #e5e5e5;padding:10px;border-radius:8px;background:#fff">
        <button id="closeDetail" style="float:right">✕</button>
        <h3 style="margin:.2rem 0 .8rem">${escapeHtml(playerById[playerId]?.name||'Player')} — ${escapeHtml(teamById[playerById[playerId]?.teamId||'']?.name||'')}</h3>
        <div class="table-scroller">
          <table class="grid" style="width:100%;font-size:.95rem">
            <thead><tr>
              <th>Date</th><th>Fixture</th><th>Home/Away</th><th>Opponent</th><th>Opponent Team</th><th>Score</th><th>Result</th><th>Breaks</th>
            </tr></thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td>${escapeHtml(formatDate(r.date))}</td>
                  <td style="text-align:left">${escapeHtml(r.fixture)}</td>
                  <td>${escapeHtml(r.hoa)}</td>
                  <td>${escapeHtml(r.opponent)}</td>
                  <td>${escapeHtml(r.oppTeam)}</td>
                  <td>${escapeHtml(r.score)}</td>
                  <td style="font-weight:700;${r.result==='W'?'color:#0a7a2a':'color:#b02a0a'}">${r.result}</td>
                  <td>${escapeHtml(r.breaks)}</td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
        <div style="clear:both"></div>
      </div>`;
    detail.innerHTML = html;
    document.querySelector('#playerDetailTemp')?.remove();
    section.appendChild(detail);
    document.getElementById('closeDetail').addEventListener('click',()=> detail.remove());
    history.replaceState(null,'', `#player=${encodeURIComponent(playerId)}`);
  }

  // Delegate clicks on player links
  document.addEventListener('click', e=>{
    const link = e.target.closest('.player-link');
    if(link){
      e.preventDefault();
      const id = link.dataset.id;
      if (id) showPlayerDetail(id);
    }
  });

  // Deep link
  (function(){
    const m = location.hash.match(/#player=([^&]+)/);
    if(m){
      const pid = decodeURIComponent(m[1]);
      if(playerById[pid]) showPlayerDetail(pid);
    }
  })();

  /* ========== View switcher ========== */
  document.querySelectorAll('.view-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const v = btn.dataset.view;

      document.getElementById('view-merit').hidden      = (v!=='merit');
      document.getElementById('view-handicaps').hidden  = (v!=='handicaps');
      document.getElementById('view-breaks').hidden     = (v!=='breaks');

      // Keep stickies aligned and weeks fitted when switching back
      if (v==='merit'){ computeStickyOffsetsMerit(); if (chkAuto.checked) fitWeeks(); }
    });
  });

  // Recompute on resize (debounced)
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(()=>{
      computeStickyOffsetsMerit();
      if (chkAuto.checked) fitWeeks();
    }, 100);
  }, { passive:true });

})();
</script>
</body>
</html>
