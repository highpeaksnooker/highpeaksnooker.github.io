<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merit — High Peak & Marple Snooker League</title>
<link rel="icon" type="image/png" href="/logo.PNG" sizes="192x192">
<link rel="apple-touch-icon" href="/logo.PNG">
<link rel="preload" as="image" href="/logo.PNG">
<link rel="stylesheet" href="style.css" />
<style>
  :root{
    --brand-green:#002b19; --banner-height:140px; --page-max:1600px; --accent:#19d36b;  /* wider by default */
    --bar-dark:#1f1f1f; --bar-border:#2a2a2a; --overlay-bg:rgba(15,17,22,.85);

    /* base widths (auto-fit adjusts --w-week) */
    --w-name:260px; --w-team:200px; --w-hcp:56px;
    --w-week:40px;  /* dynamic */
    --w-pwl:44px; --w-diff:54px; --w-25:52px; --w-hi:88px;
    --grid-font:.92rem;
  }
  html,body{margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f8fb;color:#0b1220}
  .container{max-width:var(--page-max);margin:0 auto;padding:0 12px}

  /* Crest banner */
  header.logo-header{background:var(--brand-green);box-shadow:0 2px 10px rgba(0,0,0,.25);height:var(--banner-height);display:flex;align-items:center;justify-content:center}
  .logo-banner{height:100%;display:flex;align-items:center;justify-content:center}
  .logo-banner img{height:100%;width:auto;object-fit:contain;display:block;filter:drop-shadow(0 0 6px rgba(0,0,0,.4))}

  /* Announcement */
  #announcement-banner{position:sticky;top:0;z-index:100;display:none;background:var(--bar-dark);color:#fff;font-weight:600;font-size:.85rem;padding:.35rem 0;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid var(--bar-border)}
  #announcement-inner{max-width:var(--page-max);margin:0 auto;padding:0 12px;text-align:center}

  /* Menu */
  .menu-bar{background:var(--bar-dark);padding:8px 0 10px;position:relative;z-index:110;border-bottom:1px solid var(--bar-border)}
  .menu-inner{max-width:var(--page-max);margin:0 auto;padding:0 12px;position:relative}
  .menu-toggle{width:100%;background:var(--bar-dark);color:#fff;padding:10px 12px;border:1px solid var(--bar-border);border-radius:10px;font-weight:800;font-size:1rem;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.25) inset}
  .menu-toggle:focus-visible{outline:3px solid var(--accent);outline-offset:2px}
  nav.site-nav{position:absolute;left:12px;right:12px;top:calc(100% + 6px);background:var(--overlay-bg);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:10px;box-shadow:0 18px 36px rgba(0,0,0,.45);padding:6px;z-index:120}
  [hidden]{display:none!important}
  nav.site-nav a{display:block;color:#e5e7eb;text-decoration:none;font-weight:700;padding:10px 10px;border-radius:8px}
  nav.site-nav a:hover{background:rgba(255,255,255,.1)}
  nav.site-nav a.active{background:var(--accent);color:#0b1b0f}

  /* Page */
  main.container{background:#fff;padding:1rem 12px 1.2rem;border-radius:10px;margin-top:10px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  h2{margin:.25rem 0 .6rem 0}
  .legend{margin:.25rem 0 .75rem 0;color:#475569;font-size:.95rem}

  /* View tabs */
  .view-tabs{display:flex;gap:.4rem;flex-wrap:wrap;margin:.25rem 0 .75rem}
  .view-tabs .view-btn{margin:0;padding:.4em .8em;border:none;border-radius:8px;font-weight:800;cursor:pointer;background:#eef1f5}
  .view-tabs .view-btn.active{background:var(--accent);color:#0b1b0f}

  /* Team filter tabs */
  .tabs{display:flex;flex-wrap:wrap;gap:.35rem;margin:.25rem 0 .75rem}
  .tab-btn{margin:0;padding:.35em .7em;border:none;border-radius:6px;font-weight:700;cursor:pointer;color:#000}
  .tab-btn.active{box-shadow:0 0 0 2px #333 inset}

  /* Team colour bands */
  tr.team-color-0{background-color:#e6f4ff}
  tr.team-color-1{background-color:#e6ffe6}
  tr.team-color-2{background-color:#fff0e6}
  tr.team-color-3{background-color:#f9e6ff}
  tr.team-color-4{background-color:#fffde6}
  tr.team-color-5{background-color:#f0f0ff}
  tr.team-color-6{background-color:#e6fff2}
  tr.team-color-7{background-color:#ffe6f0}
  tr.team-color-8{background-color:#f6f6f6}
  tr.team-color-9{background-color:#e0f7fa}
  .tab-btn.color-0{background:#cce8ff}.tab-btn.color-1{background:#bfffbf}.tab-btn.color-2{background:#ffd4b3}.tab-btn.color-3{background:#ebccff}.tab-btn.color-4{background:#fff9b3}.tab-btn.color-5{background:#d6d6ff}.tab-btn.color-6{background:#b3ffe0}.tab-btn.color-7{background:#ffcce0}.tab-btn.color-8{background:#dddddd}.tab-btn.color-9{background:#b2ebf2}

  /* Tables */
  .table-scroller{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table.grid{width:100%;border-collapse:separate;border-spacing:0;background:#fff;font-size:var(--grid-font);table-layout:fixed}
  .grid th,.grid td{border:1px solid #e4e4e4;padding:5px 6px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .grid thead th{background:#f0f0f0;font-weight:700}

  /* Sticky cols */
  .grid th.sticky,.grid td.sticky{position:sticky;left:var(--s0,0px);z-index:2;background:inherit}
  .grid th.sticky-2,.grid td.sticky-2{position:sticky;left:var(--s1,200px);z-index:2;background:inherit}
  .grid th.sticky-3,.grid td.sticky-3{position:sticky;left:var(--s2,380px);z-index:2;background:inherit}
  .grid td.sticky,.grid td.sticky-2,.grid td.sticky-3{box-shadow:2px 0 0 rgba(0,0,0,.05)}

  /* Column widths */
  .col-name,.col-team{text-align:left;line-height:1.15}
  .col-name{min-width:var(--w-name);font-size:.9em}
  .col-team{min-width:var(--w-team);font-size:.88em}
  .col-hcp{width:var(--w-hcp)}
  .col-week{width:var(--w-week);min-width:var(--w-week);font-variant-numeric:tabular-nums}
  .col-p,.col-w,.col-l{width:var(--w-pwl)}
  .col-diff{width:var(--w-diff)}
  .col-25{width:var(--w-25)}
  .col-hi{width:var(--w-hi)}
  .grid th.col-week,.grid td.col-week{font-size:.86em}

  /* Allow 2-line wrap for Name & Team cells (Merit & Weeks) */
  #playersGrid .col-name, #playersGrid .col-team,
  #weeksGrid   .col-name, #weeksGrid   .col-team {
    white-space:normal; overflow:visible; text-overflow:clip;
  }
  #playersGrid td.col-name a.player-link,
  #playersGrid td.col-team span,
  #weeksGrid   td.col-name a.player-link,
  #weeksGrid   td.col-team span {
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }

  /* Result colouring */
  .cell-w{background:#19c67a;color:#083;font-weight:700}
  .cell-l{background:#f6903d;color:#5a2a00;font-weight:700}
  .cell-na{background:#111;color:#fff}
  .cell-blank{background:#fff}

  /* Player links */
  a.player-link{color:#0b5; font-weight:700; text-decoration:none}
  a.player-link:hover, a.player-link:focus{ text-decoration:underline; outline:none }

  /* Player detail table */
  #playerDetail h3{margin:.2rem 0 .8rem}
  #playerFrames{border:1px solid #e5e5e5}
  #playerFrames th, #playerFrames td{border:1px solid #e5e5e5; padding:.5rem .55rem; text-align:left}
  #playerFrames thead th{background:#f0f0f0}
  .result-win{color:#0a7a2a; font-weight:700}
  .result-loss{color:#b02a0a; font-weight:700}

  /* Breaks & Handicap Changes tables */
  table.simple{width:100%;border-collapse:collapse;background:#fff;font-size:.95rem;border:1px solid #e5e5e5;table-layout:auto}
  table.simple th,table.simple td{border:1px solid #ddd;padding:.55rem .6rem;text-align:left;vertical-align:top}
  table.simple thead th{background:#f0f0f0;font-weight:700}
  .star{color:#eab308; filter: drop-shadow(0 0 1px rgba(0,0,0,.35));}

  .delta-up{color:#166534;font-weight:700}
  .delta-down{color:#9f1239;font-weight:700}
  .delta-zero{color:#475569;font-weight:700}

  footer{text-align:center;padding:1.2rem 1rem;color:#777}

  /* Mobile tweaks */
  @media (max-width:480px){
    :root{
      --banner-height:110px;
      --w-name:200px; --w-team:150px; --w-hcp:44px;
      --w-week:32px; --w-pwl:36px; --w-diff:46px; --w-25:42px; --w-hi:70px;
      --grid-font:.82rem;
    }
    .grid th,.grid td{padding:4px 5px}
    .col-name{font-size:.82em}
    .col-team{font-size:.8em}
    table.simple{font-size:.9rem}
  }

  /* small control inline */
  .controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin:.5rem 0}
  .controls .hint{color:#64748b;font-size:.9em}
</style>
</head>
<body>
<header class="logo-header" role="banner">
  <div class="logo-banner">
    <img src="logo.PNG?v=17" alt="High Peak &amp; Marple Snooker League crest">
  </div>
</header>

<div id="announcement-banner" role="status" aria-live="polite">
  <div id="announcement-inner" class="container">
    <span id="announcement-text"></span>
  </div>
</div>

<div class="menu-bar">
  <div class="menu-inner">
    <button class="menu-toggle" id="menuToggle" aria-expanded="false" aria-controls="siteNav">☰ Menu</button>
    <nav id="siteNav" class="site-nav" hidden>
      <a href="index.html">Home</a>
      <a href="fixtures.html">Fixtures</a>
      <a href="results.html">Results</a>
      <a href="merit.html" class="active">Merit</a>
      <a href="venues.html">Venues</a>
      <a href="rules.html">Rules</a>
      <a href="history.html">Honours List</a>
      <a href="archive.html">Archive</a>
    </nav>
  </div>
</div>

<main class="container">
  <h2>Merit</h2>
  <p class="legend">Default view shows **last 4 results** per player and current handicap. Use the tabs for full weekly grid, breaks, and handicap changes.</p>

  <div class="view-tabs" role="tablist" aria-label="Views">
    <button class="view-btn active" data-view="merit" aria-selected="true">Merit (Recent)</button>
    <button class="view-btn" data-view="weeks" aria-selected="false">All Weeks</button>
    <button class="view-btn" data-view="breaks" aria-selected="false">Breaks</button>
    <button class="view-btn" data-view="handicaps" aria-selected="false">Handicap Changes</button>
  </div>

  <!-- MERIT (RECENT) -->
  <section id="view-merit">
    <div class="tabs" id="teamTabs"></div>
    <div class="controls">
      <span class="hint">Team codes shown here; hover for full team names.</span>
    </div>
    <div class="table-scroller">
      <table id="playersGrid" class="grid" aria-describedby="meritHeatmap"></table>
    </div>
    <p id="meritHeatmap" class="visually-hidden">Merit table shows last four weeks only and totals.</p>
  </section>

  <!-- ALL WEEKS GRID -->
  <section id="view-weeks" hidden>
    <div class="tabs" id="teamTabsWeeks"></div>
    <div class="table-scroller">
      <table id="weeksGrid" class="grid" aria-describedby="weeksDesc"></table>
    </div>
    <p id="weeksDesc" class="visually-hidden">Full weekly results W1..W18.</p>
  </section>

  <!-- PLAYER DETAIL -->
  <section id="playerDetail" hidden style="margin-top:1rem">
    <button id="backToMerit" style="margin-bottom:1rem">← Back to Merit (Recent)</button>
    <h3 id="detailHeader"></h3>
    <table id="playerFrames" style="width:100%;border-collapse:collapse;background:#fff;font-size:0.95rem">
      <thead>
        <tr>
          <th>Date</th>
          <th>Fixture</th>
          <th>Home/Away</th>
          <th>Opponent</th>
          <th>Opponent Team</th>
          <th>Score</th>
          <th>Result</th>
          <th>Breaks</th>
        </tr>
      </thead>
      <tbody id="playerFramesBody"></tbody>
    </table>
    <p id="noFrames" style="display:none;color:#666">No frame data for this player yet.</p>
  </section>

  <!-- BREAKS -->
  <section id="view-breaks" hidden>
    <table class="simple" id="breaksTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Team</th>
          <th>25+</th>
          <th>High</th>
          <th>Breaks</th>
        </tr>
      </thead>
      <tbody id="breaksBody"></tbody>
    </table>
  </section>

  <!-- HANDICAP CHANGES -->
  <section id="view-handicaps" hidden>
    <table class="simple" id="hcpTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Team</th>
          <th>Start</th>
          <th>Current</th>
          <th>Δ</th>
        </tr>
      </thead>
      <tbody id="hcpBody"></tbody>
    </table>
  </section>
</main>

<footer>&copy; 2025 High Peak &amp; Marple Snooker League</footer>

<!-- Menu logic -->
<script>
  (function(){
    const btn=document.getElementById('menuToggle');
    const nav=document.getElementById('siteNav');
    function closeNav(){nav.hidden=true;btn.setAttribute('aria-expanded','false')}
    btn.addEventListener('click',()=>{
      const ex=btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded',String(!ex));
      nav.hidden=ex;
    });
    document.addEventListener('click',(e)=>{
      if(!nav.hidden && !nav.contains(e.target) && e.target!==btn && !btn.contains(e.target)){ closeNav(); }
    });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeNav(); });
  })();
</script>

<!-- Announcement -->
<script>
  fetch('data/announcement.json',{cache:'no-store'})
    .then(r=>r.json())
    .then(d=>{
      if(d && d.message && d.message.trim()){
        document.getElementById('announcement-text').textContent=d.message.trim();
        document.getElementById('announcement-banner').style.display='block';
      }
    })
    .catch(()=>{});
</script>

<!-- Main logic -->
<script>
(async function () {
  const WEEK_MAX = 18; // cap at 18
  const RECENT_COUNT = 4; // Merit shows last 4 only

  const [teams, players, fixtures, matches] = await Promise.all([
    fetch('data/teams.json',{cache:'no-store'}).then(r=>r.json()),
    fetch('data/players.json',{cache:'no-store'}).then(r=>r.json()),
    fetch('data/fixtures.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>[]),
    fetch('data/matches.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>[])
  ]);

  /* === Helpers & lookups === */
  const teamById = Object.fromEntries(teams.map(t => [t.id, t]));
  const playerById = Object.fromEntries(players.map(p => [p.id, p]));
  const teamColorClass = {}; teams.forEach((t,i)=> teamColorClass[t.id] = i % 10);

  const TEAM_ABBR = {
    'marple':'MAR','tintwistle1':'TIN1','tintwistle2':'TIN2',
    'hayfield-1':'HAY1','hayfield-2':'HAY2',
    'whaley-1':'WHA1','whaley-2':'WHA2',
    'alexashton':'A&A','chinley':'CHI','denton-lib':'DEN'
  };
  function abbrTeam(id){ return TEAM_ABBR[id] || teamById[id]?.name || id; }

  function isComplete(m){
    if (!m) return false;
    if (m.status === 'postponed' || m.status === 'void') return true;
    if (typeof m.homeFrames === 'number' && typeof m.awayFrames === 'number') return true;
    if (Array.isArray(m.frames) && m.frames.some(fr => fr.winner==='home' || fr.winner==='away')) return true;
    return false;
  }
  function escapeHtml(s=''){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
  function formatDate(d){
    if(!d) return '';
    const dt = new Date(d);
    if (isNaN(dt)) return d;
    return dt.toLocaleDateString('en-GB',{weekday:'short', day:'2-digit', month:'short', year:'numeric'});
  }

  /* =========================
     BREAKS — SUPPORT ALL FORMATS
     ========================= */

  // Turn any value into a numeric list (keeps only finite numbers > 0)
  function asNumberList(v){
    if (v == null) return [];
    if (typeof v === 'number') return Number.isFinite(v) && v > 0 ? [v] : [];
    if (Array.isArray(v)) return v.filter(n => typeof n === 'number' && Number.isFinite(n) && n > 0);
    return [];
  }

  // Extract breaks for a given side ("home" or "away") from whatever structure is present
  function getBreaksForSide(frame, side){
    if (!frame) return [];
    const other = side === 'home' ? 'away' : 'home';

    // 1) Preferred nested structure: frame.breaks.home / frame.breaks.away
    if (frame.breaks && typeof frame.breaks === 'object' && !Array.isArray(frame.breaks)) {
      // breaks: {home:[..], away:[..]} OR breaks:{home:28, away:26}
      if (side in frame.breaks) return asNumberList(frame.breaks[side]);

      // sometimes keys are capitalised
      const cap = side[0].toUpperCase() + side.slice(1);
      if (cap in frame.breaks) return asNumberList(frame.breaks[cap]);
    }

    // 2) Legacy direct keys on frame: homeBreaks / awayBreaks
    const k1 = side + 'Breaks';
    if (k1 in frame) return asNumberList(frame[k1]);

    // 3) Legacy single break keys: homeBreak / awayBreak
    const k2 = side + 'Break';
    if (k2 in frame) return asNumberList(frame[k2]);

    // 4) Other common variants: breaksHome / breaksAway
    const k3 = 'breaks' + (side === 'home' ? 'Home' : 'Away');
    if (k3 in frame) return asNumberList(frame[k3]);

    // 5) Single generic break fields (only usable if we can confidently attribute)
    // If frame has "break" or "breaks" as number/array without side,
    // DO NOT guess which player it belongs to. Only attribute if frame explicitly says so.
    // (We keep this conservative to avoid mis-crediting.)
    // If you later add "breakSide":"home" or similar, we can use it.
    if ('breakSide' in frame && (frame.breakSide === side)) {
      if ('break' in frame) return asNumberList(frame.break);
      if (Array.isArray(frame.breaks) || typeof frame.breaks === 'number') return asNumberList(frame.breaks);
    }

    return [];
  }

  // Extract all breaks (both sides) — used for "High" calculations if needed
  function getAllBreaks(frame){
    return [...getBreaksForSide(frame,'home'), ...getBreaksForSide(frame,'away')];
  }

  /* === Weeks & fixtures timeline === */
  const completedMatches = matches.filter(isComplete);
  const dateSet = new Set(completedMatches.map(m => m.date));
  const confirmedDatesAll = Array.from(dateSet).sort((a,b)=>new Date(a)-new Date(b));
  const weekDates = confirmedDatesAll.slice(0, WEEK_MAX);

  const teamHasFixture = {};
  for (const d of weekDates){ teamHasFixture[d] = {}; teams.forEach(t=>teamHasFixture[d][t.id]=false); }
  completedMatches.forEach(m=>{ if(teamHasFixture[m.date]){ teamHasFixture[m.date][m.homeTeamId]=true; teamHasFixture[m.date][m.awayTeamId]=true; }});
  fixtures.forEach(f=>{ if(teamHasFixture[f.date]){ teamHasFixture[f.date][f.homeTeamId]=true; teamHasFixture[f.date][f.awayTeamId]=true; }});

  /* === Build player rows + breaks accumulator === */
  const P = {};
  const breaksByPlayer = {};
  players.forEach(p=>{
    const currentHcp = (p.HCP ?? p.hcp ?? p.handicap ?? 0);
    const startHcp   = (p.startHCP ?? p.startHcp ?? p.startingHcp ?? currentHcp ?? 0);

    P[p.id] = {
      id:p.id, name:p.name, teamId:p.teamId,
      teamName:teamById[p.teamId]?.name || p.teamId,
      HCP: currentHcp,
      Start: startHcp,
      perDate: Object.fromEntries(weekDates.map(d=>[d,'blank'])),
      totals: { played:0, won:0, lost:0, diff:0, break25:0, high:0, winPct:0 }
    };
    breaksByPlayer[p.id] = { name:p.name, teamName:teamById[p.teamId]?.name || '', list:[], high:0 };
  });

  if (weekDates.length){
    for (const p of players){
      for (const d of weekDates){
        if (!teamHasFixture[d][p.teamId]) P[p.id].perDate[d] = 'na';
      }
    }
  }

  function recordFrame(frame, isHome, date){
    if (!weekDates.includes(date)) return;
    const pid = isHome ? frame.homePlayerId : frame.awayPlayerId;
    const row = P[pid];
    if (!row) return;

    // Result tracking (W/L). If winner is unknown, do nothing.
    if (row.perDate[date] !== 'na'){
      const win = frame.winner === 'home' ? isHome : frame.winner === 'away' ? !isHome : null;
      if (win === true){ row.perDate[date] = 'W'; row.totals.played++; row.totals.won++; }
      else if (win === false){ row.perDate[date] = 'L'; row.totals.played++; row.totals.lost++; }
    }

    // Break tracking (supports all formats)
    const side = isHome ? 'home' : 'away';
    const myBreaks = getBreaksForSide(frame, side);       // all breaks (>=1)
    const plus25   = myBreaks.filter(n=>n>=25);

    if (myBreaks.length){
      // High break should consider ALL breaks, not only 25+
      const myHigh = Math.max(...myBreaks);
      row.totals.high = Math.max(row.totals.high, myHigh);
      breaksByPlayer[pid].list.push(...myBreaks);
      breaksByPlayer[pid].high = Math.max(breaksByPlayer[pid].high, myHigh);
    }

    if (plus25.length){
      row.totals.break25 += plus25.length;
    }
  }

  completedMatches.forEach(m=>{
    if (!Array.isArray(m.frames)) return;
    m.frames.forEach(fr=>{
      recordFrame(fr, true,  m.date);
      recordFrame(fr, false, m.date);
    });
  });

  Object.values(P).forEach(r=>{
    r.totals.diff = r.totals.won - r.totals.lost;
    r.totals.winPct = r.totals.played ? (r.totals.won / r.totals.played) : 0;
  });

  const seriesHigh = Math.max(0, ...Object.values(P).map(x=>x.totals.high||0));
  const highBreakHolders = new Set(Object.values(P).filter(r => (r.totals.high||0)===seriesHigh && seriesHigh>0).map(r=>r.id));

  function sortRows(rows){
    return rows.sort((a,b)=>{
      if (b.totals.won !== a.totals.won) return b.totals.won - a.totals.won;
      if (a.totals.played !== b.totals.played) return a.totals.played - b.totals.played;
      const ah=a.totals.high||0, bh=b.totals.high||0;
      if (bh!==ah) return bh-ah;
      return a.name.localeCompare(b.name);
    });
  }

  /* === Team tabs (Merit & Weeks) === */
  function mkTeamTabs(containerId, onClick){
    const tabs = document.getElementById(containerId);
    tabs.innerHTML='';
    const ALL='__all__';
    function mkBtn(id,label,colorClass){
      const b=document.createElement('button');
      b.type='button';
      b.className='tab-btn'+(colorClass!==null?` color-${colorClass}`:'');
      b.dataset.teamId=id;
      b.textContent=label;
      b.addEventListener('click',()=>{
        tabs.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        onClick(id);
      });
      return b;
    }
    tabs.appendChild(mkBtn(ALL,'All Teams',null));
    teams.forEach(t=> tabs.appendChild(mkBtn(t.id,t.name,teamColorClass[t.id])));
    return tabs;
  }

  /* === Auto-fit helper for week columns === */
  function autoFitWeekWidth(tbl, weeksCount, fixedColsCount){
    const scroller = tbl.parentElement;
    const visible = scroller.clientWidth || scroller.getBoundingClientRect().width || 0;
    if (!visible) return;
    tbl.style.setProperty('--w-week','32px'); // temp
    const head = tbl.querySelector('thead tr');
    if (!head) return;

    let fixedW = 0;
    const ths = [...head.children];
    ths.forEach((th, idx)=>{
      if (idx < fixedColsCount || idx >= fixedColsCount + weeksCount) fixedW += th.offsetWidth || 0;
    });

    const gutter = 8;
    const spaceForWeeks = Math.max(0, visible - fixedW - gutter);
    const minW = 16, maxW = 42;
    const perWeek = Math.floor(spaceForWeeks / Math.max(weeksCount,1));
    const target = Math.max(minW, Math.min(maxW, perWeek));
    tbl.style.setProperty('--w-week', target + 'px');
  }

  /* === MERIT (RECENT 4) === */
  const tabsMerit = mkTeamTabs('teamTabs', id=>{
    localStorage.setItem('playersTeamFilter', id);
    renderMerit(id);
  });

  function renderMerit(teamFilter){
    const tbl = document.getElementById('playersGrid');
    const recentDates = weekDates.slice(-RECENT_COUNT); // last 4
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');

    trh.innerHTML =
      `<th class="sticky col-name">Name</th>
       <th class="sticky-2 col-team">Team</th>
       <th class="sticky-3 col-hcp" title="Current Handicap">HCP</th>`;

    recentDates.forEach((d, i)=>{
      const idx = weekDates.indexOf(d);
      const th=document.createElement('th');
      th.className='col-week';
      th.title = new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'});
      th.textContent = 'W' + (idx+1);
      trh.appendChild(th);
    });

    [['P','col-p'],['W','col-w'],['L','col-l'],['±','col-diff'],['25+','col-25'],['Hi','col-hi']]
      .forEach(([label,cls])=>{ const th=document.createElement('th'); th.textContent=label; th.className=cls; trh.appendChild(th); });

    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    let rows = Object.values(P);
    rows = (!teamFilter || teamFilter === '__all__') ? rows.filter(r => r.totals.played > 0)
                                                     : rows.filter(r => r.teamId === teamFilter && r.totals.played > 0);
    rows = sortRows(rows);

    rows.forEach(r=>{
      const isHigh = (r.totals.high||0)>0 && (r.totals.high === seriesHigh);
      const star = isHigh ? ' <span class="star" aria-label="High break holder" title="High break holder">⭐</span>' : '';
      const tr = document.createElement('tr');
      tr.className = `team-color-${teamColorClass[r.teamId] ?? 0}`;

      const nameCell = `<a href="#" class="player-link" data-id="${r.id}" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}${star}</a>`;
      const teamAb   = abbrTeam(r.teamId);
      const teamCell = `<span title="${escapeHtml(r.teamName)}">${escapeHtml(teamAb)}</span>`;

      tr.innerHTML =
       `<td class="sticky col-name">${nameCell}</td>
        <td class="sticky-2 col-team">${teamCell}</td>
        <td class="sticky-3 col-hcp">${r.HCP}</td>`;

      recentDates.forEach(d=>{
        const v = r.perDate[d];
        let cls='cell-blank', text='';
        if (v==='W') { cls='cell-w'; text='W'; }
        else if (v==='L') { cls='cell-l'; text='L'; }
        else if (v==='na'){ cls='cell-na'; }
        const td=document.createElement('td'); td.className=`col-week ${cls}`; td.textContent=text; tr.appendChild(td);
      });

      const T=r.totals;
      tr.insertAdjacentHTML('beforeend',
        `<td class="col-p">${T.played}</td>
         <td class="col-w">${T.won}</td>
         <td class="col-l">${T.lost}</td>
         <td class="col-diff">${T.diff}</td>
         <td class="col-25">${T.break25}</td>
         <td class="col-hi">${T.high || 0}</td>`);
      tbody.appendChild(tr);
    });

    tbl.replaceChildren(thead, tbody);

    // sticky offsets (Name, Team, HCP)
    const headRow = tbl.querySelector('thead tr');
    const firstRow = tbl.querySelector('tbody tr');
    const w0 = (headRow?.children[0]?.offsetWidth) || (firstRow?.children[0]?.offsetWidth) || 0;
    const w1 = (headRow?.children[1]?.offsetWidth) || (firstRow?.children[1]?.offsetWidth) || 0;
    tbl.style.setProperty('--s0','0px');
    tbl.style.setProperty('--s1', w0+'px');
    tbl.style.setProperty('--s2', (w0+w1)+'px');

    // Hide Team column if a single team filter is active (more space)
    const singleTeam = teamFilter && teamFilter !== '__all__';
    const ths = headRow.children;
    const teamColIdx = 1;
    ths[teamColIdx].style.display = singleTeam ? 'none' : '';
    tbl.querySelectorAll('tbody tr').forEach(tr=>{
      const td = tr.children[teamColIdx];
      if (td) td.style.display = singleTeam ? 'none' : '';
    });
    // Recompute stickies if hidden
    if (singleTeam){
      const w0b = (headRow?.children[0]?.offsetWidth) || (firstRow?.children[0]?.offsetWidth) || 0;
      tbl.style.setProperty('--s1', w0b+'px');
      tbl.style.setProperty('--s2', (w0b)+'px'); // HCP will shift left automatically
    }

    // Fit weeks (only 4 here, but still responsive)
    autoFitWeekWidth(tbl, recentDates.length, 3);
  }

  const storedTeam = localStorage.getItem('playersTeamFilter');
  const startTeam  = (storedTeam && teamById[storedTeam]) ? storedTeam : '__all__';
  (function setTabActive(containerId, teamId){
    const tabs = document.getElementById(containerId);
    const btn = [...tabs.children].find(b=>b.dataset.teamId===teamId) || tabs.firstChild;
    if (btn){ btn.classList.add('active'); }
  })('teamTabs', startTeam);

  renderMerit(startTeam);

  /* === ALL WEEKS === */
  const tabsWeeks = mkTeamTabs('teamTabsWeeks', id=>{
    localStorage.setItem('playersTeamFilterWeeks', id);
    renderWeeks(id);
  });

  function renderWeeks(teamFilter){
    const tbl = document.getElementById('weeksGrid');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');

    trh.innerHTML =
      `<th class="sticky col-name">Name</th>
       <th class="sticky-2 col-team">Team</th>
       <th class="sticky-3 col-hcp" title="Current Handicap">HCP</th>`;

    weekDates.forEach((d, i)=>{
      const th=document.createElement('th');
      th.className='col-week';
      th.title = new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'});
      th.textContent = 'W' + (i+1);
      trh.appendChild(th);
    });

    [['P','col-p'],['W','col-w'],['L','col-l'],['±','col-diff'],['25+','col-25'],['Hi','col-hi']]
      .forEach(([label,cls])=>{ const th=document.createElement('th'); th.textContent=label; th.className=cls; trh.appendChild(th); });

    thead.appendChild(trh);

    const tbody = document.createElement('tbody');
    let rows = Object.values(P);
    rows = (!teamFilter || teamFilter === '__all__') ? rows.filter(r => r.totals.played > 0)
                                                     : rows.filter(r => r.teamId === teamFilter && r.totals.played > 0);
    rows = sortRows(rows);

    rows.forEach(r=>{
      const isHigh = (r.totals.high||0)>0 && (r.totals.high === seriesHigh);
      const star = isHigh ? ' <span class="star" aria-label="High break holder" title="High break holder">⭐</span>' : '';
      const tr = document.createElement('tr');
      tr.className = `team-color-${teamColorClass[r.teamId] ?? 0}`;

      const nameCell = `<a href="#" class="player-link" data-id="${r.id}" title="${escapeHtml(r.name)}">${escapeHtml(r.name)}${star}</a>`;
      const teamCell = `<span title="${escapeHtml(r.teamName)}">${escapeHtml(r.teamName)}</span>`; // full name in this view

      tr.innerHTML =
       `<td class="sticky col-name">${nameCell}</td>
        <td class="sticky-2 col-team">${teamCell}</td>
        <td class="sticky-3 col-hcp">${r.HCP}</td>`;

      weekDates.forEach(d=>{
        const v = r.perDate[d];
        let cls='cell-blank', text='';
        if (v==='W') { cls='cell-w'; text='W'; }
        else if (v==='L') { cls='cell-l'; text='L'; }
        else if (v==='na'){ cls='cell-na'; }
        const td=document.createElement('td'); td.className=`col-week ${cls}`; td.textContent=text; tr.appendChild(td);
      });

      const T=r.totals;
      tr.insertAdjacentHTML('beforeend',
        `<td class="col-p">${T.played}</td>
         <td class="col-w">${T.won}</td>
         <td class="col-l">${T.lost}</td>
         <td class="col-diff">${T.diff}</td>
         <td class="col-25">${T.break25}</td>
         <td class="col-hi">${T.high || 0}</td>`);
      tbody.appendChild(tr);
    });

    tbl.replaceChildren(thead, tbody);

    // sticky offsets
    const headRow = tbl.querySelector('thead tr');
    const firstRow = tbl.querySelector('tbody tr');
    const w0 = (headRow?.children[0]?.offsetWidth) || (firstRow?.children[0]?.offsetWidth) || 0;
    const w1 = (headRow?.children[1]?.offsetWidth) || (firstRow?.children[1]?.offsetWidth) || 0;
    tbl.style.setProperty('--s0','0px');
    tbl.style.setProperty('--s1', w0+'px');
    tbl.style.setProperty('--s2', (w0+w1)+'px');

    // Hide Team column if a single team filter is active (optional here too)
    const singleTeam = teamFilter && teamFilter !== '__all__';
    const ths = headRow.children;
    const teamColIdx = 1;
    ths[teamColIdx].style.display = singleTeam ? 'none' : '';
    tbl.querySelectorAll('tbody tr').forEach(tr=>{
      const td = tr.children[teamColIdx];
      if (td) td.style.display = singleTeam ? 'none' : '';
    });
    if (singleTeam){
      const w0b = (headRow?.children[0]?.offsetWidth) || (firstRow?.children[0]?.offsetWidth) || 0;
      tbl.style.setProperty('--s1', w0b+'px');
      tbl.style.setProperty('--s2', (w0b)+'px');
    }

    autoFitWeekWidth(tbl, weekDates.length, 3);
  }

  const storedTeamWeeks = localStorage.getItem('playersTeamFilterWeeks');
  const startTeamWeeks  = (storedTeamWeeks && teamById[storedTeamWeeks]) ? storedTeamWeeks : '__all__';
  (function setTabActive(containerId, teamId){
    const tabs = document.getElementById(containerId);
    const btn = [...tabs.children].find(b=>b.dataset.teamId===teamId) || tabs.firstChild;
    if (btn){ btn.classList.add('active'); }
  })('teamTabsWeeks', startTeamWeeks);

  // Render lazily on first visit to tab
  let weeksRendered = false;

  /* === BREAKS === */
  function renderBreaks(){
    const body = document.getElementById('breaksBody');
    body.innerHTML = '';

    const seriesHigh2 = Math.max(0, ...Object.values(breaksByPlayer).map(b => b.high || 0));

    const rows = Object.entries(breaksByPlayer)
      .map(([pid,info])=>{
        const list = [...info.list].filter(n=>Number.isFinite(n) && n>0).sort((a,b)=>b-a);
        const count25 = list.filter(n=>n>=25).length;
        return { pid, name:info.name, team:info.teamName, count25, high:list[0]||0, list };
      })
      .filter(r=>r.list.length>0)
      .sort((a,b)=> (b.high-a.high)||(b.count25-a.count25)||a.name.localeCompare(b.name));

    rows.forEach(r=>{
      const isHigh = r.high === seriesHigh2 && seriesHigh2>0;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.name)}${isHigh ? ' <span class="star" aria-hidden="true">⭐</span>' : ''}</td>
        <td>${escapeHtml(r.team)}</td>
        <td>${r.count25}</td>
        <td>${r.high}${isHigh ? ' ⭐' : ''}</td>
        <td>${r.list.join(' · ')}</td>`;
      body.appendChild(tr);
    });

    if (!rows.length){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="5" style="color:#64748b">No breaks recorded yet.</td>`;
      body.appendChild(tr);
    }
  }
  renderBreaks();

  /* === HANDICAP CHANGES === */
  function renderHandicaps(){
    const body = document.getElementById('hcpBody');
    body.innerHTML = '';
    const changed = Object.values(P).filter(p => (p.HCP|0) !== (p.Start|0))
      .sort((a,b)=> a.name.localeCompare(b.name));
    changed.forEach(r=>{
      const delta = (r.HCP|0) - (r.Start|0);
      let cls='delta-zero', txt='0';
      if (delta>0){ cls='delta-up'; txt=`+${delta} ⬆︎`; }
      else if (delta<0){ cls='delta-down'; txt=`${delta} ⬇︎`; }
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.name)}</td>
        <td>${escapeHtml(r.teamName)}</td>
        <td>${r.Start}</td>
        <td>${r.HCP}</td>
        <td class="${cls}">${txt}</td>`;
      body.appendChild(tr);
    });
    if (!changed.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5" style="color:#64748b">No handicap changes recorded.</td>`;
      body.appendChild(tr);
    }
  }
  renderHandicaps();

  /* === Player Detail View === */
  function listBreaksForSide(frame, side){
    const arr = getBreaksForSide(frame, side);
    return arr.length ? arr.join(' · ') : '';
  }

  function showPlayerDetail(playerId){
    const section = document.getElementById('playerDetail');
    const tableBody = document.getElementById('playerFramesBody');
    const header = document.getElementById('detailHeader');
    const meritSection = document.getElementById('view-merit');
    const weeksSection = document.getElementById('view-weeks');

    const p = playerById[playerId];
    if(!p){ return; }

    // Hide main views, show detail
    meritSection.hidden = true;
    weeksSection.hidden = true;
    document.getElementById('view-breaks').hidden = true;
    document.getElementById('view-handicaps').hidden = true;
    section.hidden = false;
    header.textContent = `${p.name} — ${teamById[p.teamId]?.name || p.teamId}`;

    const rows = [];
    for(const m of matches){
      const frames = Array.isArray(m.frames) ? m.frames : [];
      for(const fr of frames){
        const isHome = fr.homePlayerId === playerId;
        const isAway = fr.awayPlayerId === playerId;
        if(!(isHome || isAway)) continue;

        const oppId = isHome ? fr.awayPlayerId : fr.homePlayerId;
        const opp = playerById[oppId];
        const oppTeamId = isHome ? m.awayTeamId : m.homeTeamId;
        const oppTeam = teamById[oppTeamId]?.name || oppTeamId;

        const youAreHome = isHome;
        const yourPts = (youAreHome ? fr.homePoints : fr.awayPoints);
        const oppPts  = (youAreHome ? fr.awayPoints : fr.homePoints);
        const hasPts = Number.isFinite(yourPts) && Number.isFinite(oppPts);

        const youWon = fr.winner === (youAreHome ? 'home' : 'away');
        const result = youWon ? 'W' : 'L';

        const myBreaksStr = listBreaksForSide(fr, youAreHome ? 'home' : 'away');

        rows.push({
          date: m.date,
          fixture: `${teamById[m.homeTeamId]?.name || m.homeTeamId} vs ${teamById[m.awayTeamId]?.name || m.awayTeamId}`,
          hoa: youAreHome ? 'Home' : 'Away',
          opponent: opp?.name || '—',
          oppTeam,
          score: hasPts ? `${yourPts}–${oppPts}` : '—',
          result,
          breaks: myBreaksStr
        });
      }
    }

    rows.sort((a,b)=> a.date.localeCompare(b.date));
    tableBody.innerHTML = '';
    if(!rows.length){
      document.getElementById('noFrames').style.display = '';
      return;
    }
    document.getElementById('noFrames').style.display = 'none';

    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(formatDate(r.date))}</td>
        <td>${escapeHtml(r.fixture)}</td>
        <td>${escapeHtml(r.hoa)}</td>
        <td>${escapeHtml(r.opponent)}</td>
        <td>${escapeHtml(r.oppTeam)}</td>
        <td>${escapeHtml(r.score)}</td>
        <td class="${r.result==='W'?'result-win':'result-loss'}">${r.result}</td>
        <td>${escapeHtml(r.breaks)}</td>`;
      tableBody.appendChild(tr);
    });

    history.replaceState(null,'', `#player=${encodeURIComponent(playerId)}`);
  }

  document.getElementById('backToMerit').addEventListener('click',()=>{
    document.getElementById('playerDetail').hidden = true;
    document.getElementById('view-merit').hidden = false;
    history.replaceState(null,'', location.pathname + location.search);
  });

  document.addEventListener('click', e=>{
    const link = e.target.closest('.player-link');
    if(link){
      e.preventDefault();
      const id = link.dataset.id;
      if (id) showPlayerDetail(id);
    }
  });

  // Deep link support
  (function(){
    const m = location.hash.match(/#player=([^&]+)/);
    if(m){
      const pid = decodeURIComponent(m[1]);
      if(playerById[pid]) showPlayerDetail(pid);
    }
  })();

  /* === View switcher === */
  document.querySelectorAll('.view-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const v = btn.dataset.view;

      document.getElementById('playerDetail').hidden = true;
      document.getElementById('view-merit').hidden = (v!=='merit');
      document.getElementById('view-weeks').hidden = (v!=='weeks');
      document.getElementById('view-breaks').hidden = (v!=='breaks');
      document.getElementById('view-handicaps').hidden = (v!=='handicaps');

      if (v==='weeks' && !weeksRendered){
        renderWeeks(startTeamWeeks);
        weeksRendered = true;
      }
      // Refit on return to tables
      if (v==='merit'){
        const tbl=document.getElementById('playersGrid');
        const weeksCount = tbl.querySelectorAll('thead th.col-week').length;
        autoFitWeekWidth(tbl, weeksCount, 3);
      } else if (v==='weeks'){
        const tbl=document.getElementById('weeksGrid');
        const weeksCount = tbl.querySelectorAll('thead th.col-week').length;
        autoFitWeekWidth(tbl, weeksCount, 3);
      }
    });
  });

  /* === Resize refit (debounced) === */
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(()=>{
      const meritVisible = !document.getElementById('view-merit').hidden;
      const weeksVisible = !document.getElementById('view-weeks').hidden;
      if (meritVisible){
        const tbl=document.getElementById('playersGrid');
        if (tbl){
          const weeksCount = tbl.querySelectorAll('thead th.col-week').length;
          autoFitWeekWidth(tbl, weeksCount, 3);
        }
      } else if (weeksVisible){
        const tbl=document.getElementById('weeksGrid');
        if (tbl){
          const weeksCount = tbl.querySelectorAll('thead th.col-week').length;
          autoFitWeekWidth(tbl, weeksCount, 3);
        }
      }
    }, 120);
  }, { passive:true });

})();
</script>
</body>
</html>
