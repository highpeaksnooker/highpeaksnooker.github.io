<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Merit — High Peak & Marple Snooker League</title>
<link rel="icon" type="image/png" href="/logo.PNG" sizes="192x192">
<link rel="apple-touch-icon" href="/logo.PNG">
<link rel="preload" as="image" href="/logo.PNG">
<link rel="stylesheet" href="style.css" />
<style>
  :root{
    --brand-green:#002b19; --banner-height:140px; --page-max:1400px; --accent:#19d36b;
    --bar-dark:#1f1f1f; --bar-border:#2a2a2a; --overlay-bg:rgba(15,17,22,.85);

    /* grid base widths (week width can be fixed or auto-fit via JS) */
    --w-name:220px; --w-team:200px; --w-hcp:78px; --w-start:78px;
    --w-week:36px;  /* default readable fixed width; auto-fit toggle can override */
    --w-pwl:52px; --w-diff:64px; --w-25:60px; --w-hi:96px;

    --grid-font:.94rem;
    --row-pad-v:6px; --row-pad-h:8px;
  }
  html,body{margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f8fb;color:#0b1220}
  .container{max-width:var(--page-max);margin:0 auto;padding:0 12px}
  .container.wide{max-width:100%}

  /* Crest banner */
  header.logo-header{background:var(--brand-green);box-shadow:0 2px 10px rgba(0,0,0,.25);height:var(--banner-height);display:flex;align-items:center;justify-content:center}
  .logo-banner{height:100%;display:flex;align-items:center;justify-content:center}
  .logo-banner img{height:100%;width:auto;object-fit:contain;display:block;filter:drop-shadow(0 0 6px rgba(0,0,0,.4))}

  /* Announcement */
  #announcement-banner{position:sticky;top:0;z-index:100;display:none;background:var(--bar-dark);color:#fff;font-weight:600;font-size:.85rem;padding:.35rem 0;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid var(--bar-border)}
  #announcement-inner{max-width:var(--page-max);margin:0 auto;padding:0 12px;text-align:center}

  /* Menu */
  .menu-bar{background:var(--bar-dark);padding:8px 0 10px;position:relative;z-index:110;border-bottom:1px solid var(--bar-border)}
  .menu-inner{max-width:var(--page-max);margin:0 auto;padding:0 12px;position:relative}
  .menu-inner.wide{max-width:100%}
  .menu-toggle{width:100%;background:var(--bar-dark);color:#fff;padding:10px 12px;border:1px solid var(--bar-border);border-radius:10px;font-weight:800;font-size:1rem;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.25) inset}
  .menu-toggle:focus-visible{outline:3px solid var(--accent);outline-offset:2px}
  nav.site-nav{position:absolute;left:12px;right:12px;top:calc(100% + 6px);background:var(--overlay-bg);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:10px;box-shadow:0 18px 36px rgba(0,0,0,.45);padding:6px;z-index:120}
  [hidden]{display:none!important}
  nav.site-nav a{display:block;color:#e5e7eb;text-decoration:none;font-weight:700;padding:10px 10px;border-radius:8px}
  nav.site-nav a:hover{background:rgba(255,255,255,.1)}
  nav.site-nav a.active{background:var(--accent);color:#0b1b0f}

  /* Page */
  main.container{background:#fff;padding:1rem 12px 1.2rem;border-radius:10px;margin-top:10px;box-shadow:0 1px 2px rgba(0,0,0,.06)}
  h2{margin:.25rem 0 .6rem 0}
  .legend{margin:.25rem 0 .5rem 0;color:#475569;font-size:.95rem}
  .legend strong{color:#0b1b0f}

  /* Controls row */
  .controls{display:flex;flex-wrap:wrap;gap:.5rem 1rem;align-items:center;margin:.5rem 0 .9rem}
  .controls .seg{display:flex;align-items:center;gap:.4rem}
  .controls label{font-size:.9rem;color:#334155}
  .controls input[type="checkbox"]{transform:translateY(1px)}
  .btn{margin:0;padding:.45em .7em;border:1px solid #d7dbe3;border-radius:8px;background:#f3f5f9;font-weight:800;cursor:pointer}
  .btn.active{background:var(--accent);color:#0b1b0f;border-color:#12b161}
  .btn:focus-visible{outline:3px solid var(--accent);outline-offset:2px}

  /* Team filter tabs */
  .tabs{display:flex;flex-wrap:wrap;gap:.35rem;margin:.25rem 0 .75rem}
  .tab-btn{margin:0;padding:.35em .7em;border:1px solid #d7dbe3;border-radius:6px;font-weight:700;cursor:pointer;color:#000;background:#eef1f5}
  .tab-btn.active{box-shadow:0 0 0 2px #333 inset}

  /* Team colour bands */
  tr.team-color-0{background-color:#e6f4ff}
  tr.team-color-1{background-color:#e6ffe6}
  tr.team-color-2{background-color:#fff0e6}
  tr.team-color-3{background-color:#f9e6ff}
  tr.team-color-4{background-color:#fffde6}
  tr.team-color-5{background-color:#f0f0ff}
  tr.team-color-6{background-color:#e6fff2}
  tr.team-color-7{background-color:#ffe6f0}
  tr.team-color-8{background-color:#f6f6f6}
  tr.team-color-9{background-color:#e0f7fa}
  .tab-btn.color-0{background:#cce8ff}.tab-btn.color-1{background:#bfffbf}.tab-btn.color-2{background:#ffd4b3}.tab-btn.color-3{background:#ebccff}.tab-btn.color-4{background:#fff9b3}.tab-btn.color-5{background:#d6d6ff}.tab-btn.color-6{background:#b3ffe0}.tab-btn.color-7{background:#ffcce0}.tab-btn.color-8{background:#dddddd}.tab-btn.color-9{background:#b2ebf2}

  /* Merit grid */
  .table-scroller{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .player-grid{width:100%;border-collapse:separate;border-spacing:0;background:#fff;font-size:var(--grid-font);table-layout:fixed}
  .player-grid th,.player-grid td{
    border:1px solid #e4e4e4;
    padding:var(--row-pad-v) var(--row-pad-h);
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .player-grid thead th{background:#f0f0f0;font-weight:700}
  .player-grid th.sticky,.player-grid td.sticky{position:sticky;left:var(--s0,0px);z-index:2;background:inherit}
  .player-grid th.sticky-2,.player-grid td.sticky-2{position:sticky;left:var(--s1,200px);z-index:2;background:inherit}
  .player-grid th.sticky-3,.player-grid td.sticky-3{position:sticky;left:var(--s2,380px);z-index:2;background:inherit}
  .player-grid th.sticky-4,.player-grid td.sticky-4{position:sticky;left:var(--s3,436px);z-index:2;background:inherit}
  .player-grid td.sticky,.player-grid td.sticky-2,.player-grid td.sticky-3,.player-grid td.sticky-4{box-shadow:2px 0 0 rgba(0,0,0,.05)}
  .col-name,.col-team{text-align:left;line-height:1.15;white-space:normal} /* allow wrap for wide names/teams */
  .col-name{min-width:var(--w-name);font-size:.9em}
  .col-team{min-width:var(--w-team);font-size:.88em}
  .col-hcp{width:var(--w-hcp)}
  .col-start{width:var(--w-start)}
  .col-week{width:var(--w-week);min-width:var(--w-week);font-variant-numeric:tabular-nums}
  .col-p,.col-w,.col-l{width:var(--w-pwl)}
  .col-diff{width:var(--w-diff)}
  .col-25{width:var(--w-25)}
  .col-hi{width:var(--w-hi)}

  .cell-w{background:#19c67a;color:#083;font-weight:700}
  .cell-l{background:#f6903d;color:#5a2a00;font-weight:700}
  .cell-na{background:#111;color:#fff}
  .cell-blank{background:#fff}

  /* HCP change badge */
  .hcp-badge{display:inline-flex;align-items:center;gap:.25rem;font-size:.78em;font-weight:800;background:#ecfdf5;color:#065f46;border:1px solid #c7f0e3;border-radius:6px;padding:0 .35rem;margin-left:.25rem}
  .hcp-badge.down{background:#fff7ed;color:#78350f;border-color:#f5d6b3}

  /* Clickable player links */
  a.player-link{color:#0b5; font-weight:700; text-decoration:none}
  a.player-link:hover, a.player-link:focus{ text-decoration:underline; outline:none }

  /* Player detail table */
  #playerDetail h3{margin:.2rem 0 .8rem}
  #playerFrames{border:1px solid #e5e5e5}
  #playerFrames th, #playerFrames td{border:1px solid #e5e5e5; padding:.5rem .55rem; text-align:left}
  #playerFrames thead th{background:#f0f0f0}
  .result-win{color:#0a7a2a; font-weight:700}
  .result-loss{color:#b02a0a; font-weight:700}

  /* Breaks table */
  .breaks-wrap{margin-top:.5rem}
  table.breaks{width:100%;border-collapse:collapse;background:#fff;font-size:.95rem;border:1px solid #e5e5e5;table-layout:auto}
  table.breaks th,table.breaks td{border:1px solid #ddd;padding:.55rem .6rem;text-align:left;vertical-align:top}
  table.breaks thead th{background:#f0f0f0;font-weight:700}
  .col-b-name{min-width:200px}
  .col-b-team{min-width:160px}
  .col-b-count{width:70px;text-align:center}
  .col-b-high{width:90px;text-align:center}
  .col-b-list{width:auto}
  .star{color:#eab308; filter: drop-shadow(0 0 1px rgba(0,0,0,.35));}

  footer{text-align:center;padding:1.2rem 1rem;color:#777}

  /* Mobile tweaks */
  @media (max-width:480px){
    :root{
      --banner-height:110px;
      --w-name:160px; --w-team:130px; --w-hcp:60px; --w-start:60px;
      --w-week:30px; --w-pwl:44px; --w-diff:54px; --w-25:54px; --w-hi:80px;
      --grid-font:.85rem;
      --row-pad-v:5px; --row-pad-h:6px;
    }
    .player-grid th,.player-grid td{padding:var(--row-pad-v) var(--row-pad-h)}
    .col-name{font-size:.82em}
    .col-team{font-size:.8em}
    .col-b-name{min-width:150px}
    .col-b-team{min-width:110px}
    table.breaks{font-size:.88rem}
  }
</style>
</head>
<body>
<header class="logo-header" role="banner">
  <div class="logo-banner">
    <img src="logo.PNG?v=16" alt="High Peak &amp; Marple Snooker League crest">
  </div>
</header>

<div id="announcement-banner" role="status" aria-live="polite">
  <div id="announcement-inner" class="container">
    <span id="announcement-text"></span>
  </div>
</div>

<div class="menu-bar">
  <div id="menuWide" class="menu-inner">
    <button class="menu-toggle" id="menuToggle" aria-expanded="false" aria-controls="siteNav">☰ Menu</button>
    <nav id="siteNav" class="site-nav" hidden>
      <a href="index.html">Home</a>
      <a href="fixtures.html">Fixtures</a>
      <a href="results.html">Results</a>
      <a href="merit.html" class="active">Merit</a>
      <a href="venues.html">Venues</a>
      <a href="rules.html">Rules</a>
      <a href="history.html">Honours List</a>
      <a href="archive.html">Archive</a>
    </nav>
  </div>
</div>

<main id="pageContainer" class="container">
  <h2>Merit</h2>
  <p class="legend">
    <strong>Matches use <u>Current HCP</u>.</strong> “Start HCP” is shown for reference (original pre-season value).
    A ▲/▼ badge indicates a review change.
  </p>

  <!-- Controls -->
  <div class="controls" aria-label="View options">
    <div class="seg">
      <button id="btnWide" class="btn" type="button" title="Toggle full-width layout">Wide Mode</button>
      <button id="btnDensity" class="btn" type="button" title="Toggle row density">Compact</button>
    </div>
    <div class="seg">
      <label><input id="chkAutoFit" type="checkbox"> Auto-fit week columns</label>
    </div>
  </div>

  <div class="view-tabs" style="margin:.2rem 0 .6rem">
    <button class="view-btn btn active" data-view="merit">Merit Table</button>
    <button class="view-btn btn" data-view="breaks">Breaks</button>
  </div>

  <!-- MERIT VIEW -->
  <section id="view-merit">
    <div class="tabs" id="teamTabs"></div>
    <div class="table-scroller">
      <table id="playersGrid" class="player-grid" aria-describedby="meritHeatmap"></table>
    </div>
    <p id="meritHeatmap" class="visually-hidden">Player weekly results grid with wins/losses by week (W1..W18) and totals.</p>
  </section>

  <!-- PLAYER DETAIL VIEW (initially hidden) -->
  <section id="playerDetail" hidden style="margin-top:1rem">
    <button id="backToMerit" class="btn" style="margin-bottom:1rem">← Back to Merit Table</button>
    <h3 id="detailHeader"></h3>
    <table id="playerFrames" style="width:100%;border-collapse:collapse;background:#fff;font-size:0.95rem">
      <thead>
        <tr>
          <th>Date</th>
          <th>Fixture</th>
          <th>Home/Away</th>
          <th>Opponent</th>
          <th>Opponent Team</th>
          <th>Score</th>
          <th>Result</th>
          <th>Breaks</th>
        </tr>
      </thead>
      <tbody id="playerFramesBody"></tbody>
    </table>
    <p id="noFrames" style="display:none;color:#666">No frame data for this player yet.</p>
  </section>

  <!-- BREAKS VIEW -->
  <section id="view-breaks" hidden>
    <div class="breaks-wrap">
      <table class="breaks" id="breaksTable">
        <thead>
          <tr>
            <th class="col-b-name">Player</th>
            <th class="col-b-team">Team</th>
            <th class="col-b-count">25+</th>
            <th class="col-b-high">High</th>
            <th class="col-b-list">Breaks</th>
          </tr>
        </thead>
        <tbody id="breaksBody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer>&copy; 2025 High Peak &amp; Marple Snooker League</footer>

<!-- Menu logic -->
<script>
  (function(){
    const btn=document.getElementById('menuToggle');
    const nav=document.getElementById('siteNav');
    function closeNav(){nav.hidden=true;btn.setAttribute('aria-expanded','false')}
    btn.addEventListener('click',()=>{
      const ex=btn.getAttribute('aria-expanded')==='true';
      btn.setAttribute('aria-expanded',String(!ex));
      nav.hidden=ex;
    });
    document.addEventListener('click',(e)=>{
      if(!nav.hidden && !nav.contains(e.target) && e.target!==btn && !btn.contains(e.target)){ closeNav(); }
    });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeNav(); });
  })();
</script>

<!-- Announcement -->
<script>
  fetch('data/announcement.json',{cache:'no-store'})
    .then(r=>r.json())
    .then(d=>{
      if(d && d.message && d.message.trim()){
        document.getElementById('announcement-text').textContent=d.message.trim();
        document.getElementById('announcement-banner').style.display='block';
      }
    })
    .catch(()=>{});
</script>

<!-- Merit / Breaks / Player Detail logic -->
<script>
(async function () {
  const WEEK_MAX = 18; // render W1..W18

  const [teams, players, fixtures, matches] = await Promise.all([
    fetch('data/teams.json',{cache:'no-store'}).then(r=>r.json()),
    fetch('data/players.json',{cache:'no-store'}).then(r=>r.json()),
    fetch('data/fixtures.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>[]),
    fetch('data/matches.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>[])
  ]);

  const teamById = Object.fromEntries(teams.map(t => [t.id, t]));
  const playerById = Object.fromEntries(players.map(p => [p.id, p]));
  const teamColorClass = {}; teams.forEach((t,i)=> teamColorClass[t.id] = i % 10);

  function isComplete(m){
    if (!m) return false;
    if (m.status === 'postponed' || m.status === 'void') return true;
    if (typeof m.homeFrames === 'number' && typeof m.awayFrames === 'number') return true;
    if (Array.isArray(m.frames) && m.frames.some(fr => fr.winner==='home' || fr.winner==='away')) return true;
    return false;
  }
  function escapeHtml(s=''){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
  function toBreakList(x){
    if (!x) return [];
    // supports: number | number[] | {home:number[]|number, away:number[]|number}
    const arr = Array.isArray(x) ? x : (typeof x === 'number' ? [x] : []);
    return arr.filter(n=>typeof n==='number');
  }

  // Confirmed dates from completed matches
  const completedMatches = matches.filter(isComplete);
  const dateSet = new Set(completedMatches.map(m => m.date));
  const confirmedDatesAll = Array.from(dateSet).sort((a,b)=>new Date(a)-new Date(b));
  const weekDates = confirmedDatesAll.slice(0, WEEK_MAX); // cap at 18

  // Which teams had fixtures on those dates
  const teamHasFixture = {};
  for (const d of weekDates){ teamHasFixture[d] = {}; teams.forEach(t=>teamHasFixture[d][t.id]=false); }
  completedMatches.forEach(m=>{ if(teamHasFixture[m.date]){ teamHasFixture[m.date][m.homeTeamId]=true; teamHasFixture[m.date][m.awayTeamId]=true; }});
  fixtures.forEach(f=>{ if(teamHasFixture[f.date]){ teamHasFixture[f.date][f.homeTeamId]=true; teamHasFixture[f.date][f.awayTeamId]=true; }});

  // Player rows + breaks accumulator
  const P = {};
  const breaksByPlayer = {};
  players.forEach(p=>{
    // Canonical numeric values with correct fallbacks
    const currentHcp  = Number(p.HCP ?? p.hcp ?? p.handicap ?? 0);
    const startingHcp = (p.startHCP !== undefined && p.startHCP !== null)
      ? Number(p.startHCP)
      : Number(p.startingHcp ?? p.hcp_start ?? currentHcp);

    P[p.id] = {
      id:p.id, name:p.name, teamId:p.teamId,
      teamName:teamById[p.teamId]?.name || '',
      HCP: currentHcp,
      Start: startingHcp,
      perDate: Object.fromEntries(weekDates.map(d=>[d,'blank'])),
      totals: { played:0, won:0, lost:0, diff:0, break25:0, high:0, winPct:0 }
    };
    breaksByPlayer[p.id] = { name:p.name, teamName:teamById[p.teamId]?.name || '', list:[], high:0 };
  });

  if (weekDates.length){
    for (const p of players){
      for (const d of weekDates){
        if (!teamHasFixture[d][p.teamId]) P[p.id].perDate[d] = 'na';
      }
    }
  }

  function recordFrame(frame, isHome, date){
    if (!weekDates.includes(date)) return;
    const pid = isHome ? frame.homePlayerId : frame.awayPlayerId;
    const row = P[pid];
    if (!row) return;

    if (row.perDate[date] !== 'na'){
      const win = frame.winner === 'home' ? isHome : frame.winner === 'away' ? !isHome : null;
      if (win === true){ row.perDate[date] = 'W'; row.totals.played++; row.totals.won++; }
      else if (win === false){ row.perDate[date] = 'L'; row.totals.played++; row.totals.lost++; }
    }

    const mine = isHome ? frame?.breaks?.home : frame?.breaks?.away;
    const plus25 = toBreakList(mine).filter(n=>n>=25);
    if (plus25.length){
      row.totals.break25 += plus25.length;
      row.totals.high = Math.max(row.totals.high, ...plus25);
      breaksByPlayer[pid].list.push(...plus25);
      breaksByPlayer[pid].high = Math.max(breaksByPlayer[pid].high, ...plus25);
    }
  }
  completedMatches.forEach(m=>{
    if (!Array.isArray(m.frames)) return;
    m.frames.forEach(fr=>{
      recordFrame(fr, true,  m.date);
      recordFrame(fr, false, m.date);
    });
  });

  Object.values(P).forEach(r=>{
    r.totals.diff = r.totals.won - r.totals.lost;
    r.totals.winPct = r.totals.played ? (r.totals.won / r.totals.played) : 0;
  });

  function sortRows(rows){
    return rows.sort((a,b)=>{
      if (b.totals.won !== a.totals.won) return b.totals.won - a.totals.won;
      if (a.totals.played !== b.totals.played) return a.totals.played - b.totals.played;
      const ah=a.totals.high||0, bh=b.totals.high||0;
      if (bh!==ah) return bh-ah;
      return a.name.localeCompare(b.name);
    });
  }

  // Team tabs
  const tabs = document.getElementById('teamTabs');
  const ALL='__all__';
  function mkBtn(id,label,colorClass){
    const b=document.createElement('button');
    b.type='button';
    b.className='tab-btn'+(colorClass!==null?` color-${colorClass}`:'');
    b.dataset.teamId=id;
    b.textContent=label;
    b.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      localStorage.setItem('playersTeamFilter',id);
      const newUrl = id && id!==ALL ? `?team=${encodeURIComponent(id)}` : location.pathname;
      history.replaceState(null,'',newUrl);
      renderMerit(id);
    });
    return b;
  }
  tabs.appendChild(mkBtn(ALL,'All Teams',null));
  teams.forEach(t=> tabs.appendChild(mkBtn(t.id,t.name,teamColorClass[t.id])));

  const urlTeam=new URLSearchParams(location.search).get('team');
  const stored=localStorage.getItem('playersTeamFilter');
  const startId=(urlTeam&&teamById[urlTeam])?urlTeam:(stored&&teamById[stored]?stored:ALL);
  const startBtn=[...tabs.children].find(b=>b.dataset.teamId===startId)||tabs.firstChild;
  startBtn.classList.add('active');

  /* ===== Flexible week column width =====
     If Auto-fit is enabled, we squeeze week columns to fit.
     If disabled (default), we keep a readable fixed width with horizontal scroll. */
  function autoFitWeekWidth(tbl, weeksCount){
    const scroller = tbl.parentElement;
    const visible = scroller.clientWidth || scroller.getBoundingClientRect().width || 0;
    if (!visible) return;
    tbl.style.setProperty('--w-week','32px'); // temp for measuring

    const head = tbl.querySelector('thead tr');
    if (!head) return;

    let fixedW = 0;
    head.childNodes.forEach((th, idx)=>{
      // 4 fixed columns: Name, Team, Current HCP, Start HCP + trailing totals
      if (idx < 4 || idx >= 4 + weeksCount) { fixedW += th.offsetWidth || 0; }
    });

    const gutter = 12;
    const spaceForWeeks = Math.max(0, visible - fixedW - gutter);
    const minW = 18, maxW = 44;
    const perWeek = Math.floor(spaceForWeeks / Math.max(weeksCount,1));
    const target = Math.max(minW, Math.min(maxW, perWeek));
    tbl.style.setProperty('--w-week', target + 'px');
  }

  // Render Merit (with W1..Wn headers)
  function renderMerit(teamFilter){
    const tbl = document.getElementById('playersGrid');

    const thead = document.createElement('thead');
    const thRow = document.createElement('tr');
    thRow.innerHTML =
      `<th class="sticky col-name">Name</th>
       <th class="sticky-2 col-team">Team</th>
       <th class="sticky-3 col-hcp"   title="Current handicap after reviews — used in matches">Current HCP</th>
       <th class="sticky-4 col-start" title="Original/starting handicap (pre-season)">Start HCP</th>`;

    weekDates.forEach((d, i)=>{
      const dt = new Date(d);
      const ddmmyyLong = dt.toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'});
      const th=document.createElement('th');
      th.className='col-week';
      th.title = ddmmyyLong;        // full date on tooltip
      th.textContent = 'W' + (i+1); // header label
      thRow.appendChild(th);
    });

    [['P','col-p'],['W','col-w'],['L','col-l'],['+/-','col-diff'],['25+','col-25'],['High Break','col-hi']]
      .forEach(([label,cls])=>{
        const th=document.createElement('th'); th.textContent=label; th.className=cls; thRow.appendChild(th);
      });

    thead.appendChild(thRow);

    const tbody = document.createElement('tbody');
    let rows = Object.values(P);
    rows = (!teamFilter || teamFilter === '__all__') ? rows.filter(r => r.totals.played > 0)
                                                     : rows.filter(r => r.teamId === teamFilter && r.totals.played > 0);
    rows = sortRows(rows);

    const seriesHigh = Math.max(0, ...Object.values(P).map(x=>x.totals.high||0));

    rows.forEach(r=>{
      const isHighHolder = (r.totals.high||0)>0 && (r.totals.high === seriesHigh);
      const star = isHighHolder ? ' <span class="star" aria-label="High break holder" title="High break holder">⭐</span>' : '';

      const tr = document.createElement('tr');
      tr.className = `team-color-${teamColorClass[r.teamId] ?? 0}`;

      const changed = (r.HCP !== r.Start);
      const direction = r.HCP > r.Start ? 'up' : (r.HCP < r.Start ? 'down' : '');
      const badge = changed
        ? `<span class="hcp-badge ${direction==='down'?'down':''}" title="${r.HCP>r.Start?'Increased':'Decreased'} from Start">${direction==='up'?'▲':'▼'}</span>`
        : '';

      const nameCell = `<a href="#" class="player-link" data-id="${r.id}" title="View full results">${escapeHtml(r.name)}${star}</a>`;
      const teamCell = `${escapeHtml(r.teamName)}`;

      tr.innerHTML =
       `<td class="sticky col-name">${nameCell}</td>
        <td class="sticky-2 col-team">${teamCell}</td>
        <td class="sticky-3 col-hcp">${r.HCP}${badge}</td>
        <td class="sticky-4 col-start">${r.Start}</td>`;

      weekDates.forEach(d=>{
        const v = r.perDate[d];
        let cls='cell-blank', text='';
        if (v==='W') { cls='cell-w'; text='W'; }
        else if (v==='L') { cls='cell-l'; text='L'; }
        else if (v==='na'){ cls='cell-na'; }
        const td=document.createElement('td'); td.className=`col-week ${cls}`; td.textContent=text; tr.appendChild(td);
      });

      const T=r.totals;
      tr.insertAdjacentHTML('beforeend',
        `<td class="col-p">${T.played}</td>
         <td class="col-w">${T.won}</td>
         <td class="col-l">${T.lost}</td>
         <td class="col-diff">${T.diff}</td>
         <td class="col-25">${T.break25}</td>
         <td class="col-hi">${T.high || 0}</td>`);
      tbody.appendChild(tr);
    });

    tbl.replaceChildren(thead, tbody);

    // sticky offsets for first 4 cols
    const headRow = tbl.querySelector('thead tr');
    const firstRow = tbl.querySelector('tbody tr');
    const w0 = (headRow?.children[0]?.offsetWidth) || (firstRow?.children[0]?.offsetWidth) || 0;
    const w1 = (headRow?.children[1]?.offsetWidth) || (firstRow?.children[1]?.offsetWidth) || 0;
    const w2 = (headRow?.children[2]?.offsetWidth) || (firstRow?.children[2]?.offsetWidth) || 0;
    tbl.style.setProperty('--s0','0px');
    tbl.style.setProperty('--s1', w0+'px');
    tbl.style.setProperty('--s2', (w0+w1)+'px');
    tbl.style.setProperty('--s3', (w0+w1+w2)+'px');

    // column sizing mode
    const auto = document.getElementById('chkAutoFit').checked;
    if (auto) autoFitWeekWidth(tbl, weekDates.length);
    else tbl.style.setProperty('--w-week', getComputedStyle(document.documentElement).getPropertyValue('--w-week') || '36px');
  }

  // Initial UI state
  const storedAuto = localStorage.getItem('playersAutoFitWeeks');
  const storedWide = localStorage.getItem('playersWideMode');
  const storedDense = localStorage.getItem('playersDensity');

  const chkAuto = document.getElementById('chkAutoFit');
  chkAuto.checked = storedAuto ? (storedAuto === '1') : false; // default OFF

  const pageContainer = document.getElementById('pageContainer');
  const menuWide = document.getElementById('menuWide');

  function setWide(on){
    pageContainer.classList.toggle('wide', on);
    menuWide.classList.toggle('wide', on);
    localStorage.setItem('playersWideMode', on ? '1' : '0');
    document.getElementById('btnWide').classList.toggle('active', on);
    // re-render to recompute widths if auto-fit is on
    const tbl=document.getElementById('playersGrid');
    if (tbl && chkAuto.checked){
      const weeksCount = tbl.querySelectorAll('thead th.col-week').length;
      autoFitWeekWidth(tbl, weeksCount);
    }
  }
  setWide(storedWide === '1');

  function setDensity(mode){
    if (mode === 'compact'){
      document.documentElement.style.setProperty('--grid-font','.90rem');
      document.documentElement.style.setProperty('--row-pad-v','4px');
      document.documentElement.style.setProperty('--row-pad-h','6px');
    }else{
      document.documentElement.style.setProperty('--grid-font','.94rem');
      document.documentElement.style.setProperty('--row-pad-v','6px');
      document.documentElement.style.setProperty('--row-pad-h','8px');
    }
    localStorage.setItem('playersDensity', mode);
    document.getElementById('btnDensity').classList.toggle('active', mode==='compact');
  }
  setDensity(storedDense || 'comfort');

  // Wire up controls
  document.getElementById('btnWide').addEventListener('click',()=>{
    const on = !pageContainer.classList.contains('wide');
    setWide(on);
  });
  document.getElementById('btnDensity').addEventListener('click',()=>{
    const nowCompact = !(localStorage.getItem('playersDensity')==='compact');
    setDensity(nowCompact ? 'compact' : 'comfort');
  });
  chkAuto.addEventListener('change',()=>{
    localStorage.setItem('playersAutoFitWeeks', chkAuto.checked ? '1' : '0');
    renderMerit(localStorage.getItem('playersTeamFilter') || '__all__');
  });

  // First render
  renderMerit(startId);

  // === Player Detail View ===
  function formatDate(d){
    if(!d) return '';
    const dt = new Date(d);
    if (isNaN(dt)) return d; // fallback to raw
    return dt.toLocaleDateString('en-GB',{weekday:'short', day:'2-digit', month:'short', year:'numeric'});
  }
  function listBreaks(b){
    if(!b) return '';
    const arr = Array.isArray(b) ? b : (typeof b==='number' ? [b] : []);
    const plus = arr.filter(n=>typeof n==='number' && n>=0);
    return plus.join(' · ');
  }

  function showPlayerDetail(playerId){
    const section = document.getElementById('playerDetail');
    const tableBody = document.getElementById('playerFramesBody');
    const header = document.getElementById('detailHeader');
    const meritSection = document.getElementById('view-merit');
    const p = playerById[playerId];
    if(!p){ return; }

    // Hide main merit view, show detail view
    meritSection.hidden = true;
    section.hidden = false;
    header.textContent = `${p.name} — ${teamById[p.teamId]?.name || p.teamId}`;

    // Gather all frames from matches.json
    const rows = [];
    for(const m of matches){
      const frames = Array.isArray(m.frames) ? m.frames : [];
      for(const fr of frames){
        const isHome = fr.homePlayerId === playerId;
        const isAway = fr.awayPlayerId === playerId;
        if(!(isHome || isAway)) continue;

        const oppId = isHome ? fr.awayPlayerId : fr.homePlayerId;
        const opp = playerById[oppId];
        const oppTeamId = isHome ? m.awayTeamId : m.homeTeamId;
        const oppTeam = teamById[oppTeamId]?.name || oppTeamId;

        const youAreHome = isHome;
        const yourPts = (youAreHome ? fr.homePoints : fr.awayPoints);
        const oppPts  = (youAreHome ? fr.awayPoints : fr.homePoints);
        const hasPts = Number.isFinite(yourPts) && Number.isFinite(oppPts);

        const youWon = fr.winner === (youAreHome ? 'home' : 'away');
        const result = youWon ? 'W' : 'L';

        const myBreaks = youAreHome ? fr?.breaks?.home : fr?.breaks?.away;

        rows.push({
          date: m.date,
          fixture: `${teamById[m.homeTeamId]?.name || m.homeTeamId} vs ${teamById[m.awayTeamId]?.name || m.awayTeamId}`,
          hoa: youAreHome ? 'Home' : 'Away',
          opponent: opp?.name || '—',
          oppTeam,
          score: hasPts ? `${yourPts}–${oppPts}` : '—',
          result,
          breaks: listBreaks(myBreaks)
        });
      }
    }

    rows.sort((a,b)=> a.date.localeCompare(b.date));
    tableBody.innerHTML = '';
    if(!rows.length){
      document.getElementById('noFrames').style.display = '';
      return;
    }
    document.getElementById('noFrames').style.display = 'none';

    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(formatDate(r.date))}</td>
        <td>${escapeHtml(r.fixture)}</td>
        <td>${escapeHtml(r.hoa)}</td>
        <td>${escapeHtml(r.opponent)}</td>
        <td>${escapeHtml(r.oppTeam)}</td>
        <td>${escapeHtml(r.score)}</td>
        <td class="${r.result==='W'?'result-win':'result-loss'}">${r.result}</td>
        <td>${escapeHtml(r.breaks)}</td>`;
      tableBody.appendChild(tr);
    });

    // Put player id in hash so you can deep-link / refresh
    history.replaceState(null,'', `#player=${encodeURIComponent(playerId)}`);
  }

  // Deep-link support
  (function(){
    const m = location.hash.match(/#player=([^&]+)/);
    if(m){
      const pid = decodeURIComponent(m[1]);
      if(playerById[pid]) showPlayerDetail(pid);
    }
  })();

  // Back button
  document.getElementById('backToMerit').addEventListener('click',()=>{
    document.getElementById('playerDetail').hidden = true;
    document.getElementById('view-merit').hidden = false;
    if (location.hash.startsWith('#player=')) {
      history.replaceState(null,'', location.pathname + location.search);
    }
  });

  // Delegate clicks on player links
  document.addEventListener('click', e=>{
    const link = e.target.closest('.player-link');
    if(link){
      e.preventDefault();
      const id = link.dataset.id;
      if (id) showPlayerDetail(id);
    }
  });

  // Breaks view
  function renderBreaks(){
    const body = document.getElementById('breaksBody');
    body.innerHTML = '';

    const seriesHigh = Math.max(0, ...Object.values(breaksByPlayer).map(b => b.high || 0));
    const rows = Object.entries(breaksByPlayer)
      .map(([pid,info])=>{
        const list = [...info.list].sort((a,b)=>b-a);
        return { pid, name:info.name, team:info.teamName, count:list.length, high:list[0]||0, list };
      })
      .filter(r=>r.count>0)
      .sort((a,b)=> (b.high-a.high)||(b.count-a.count)||a.name.localeCompare(b.name));

    rows.forEach(r=>{
      const isHigh = r.high === seriesHigh && seriesHigh>0;
      const star = isHigh ? ' <span class="star" aria-hidden="true">⭐</span>' : '';
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="col-b-name">${escapeHtml(r.name)}${star}</td>
        <td class="col-b-team">${escapeHtml(r.team)}</td>
        <td class="col-b-count">${r.count}</td>
        <td class="col-b-high">${r.high}${isHigh ? ' ⭐' : ''}</td>
        <td class="col-b-list">${r.list.join(' · ')}</td>`;
      body.appendChild(tr);
    });
  }
  renderBreaks();

  // View switcher
  document.querySelectorAll('.view-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const v = btn.dataset.view;

      // If a player detail is open and user switches tabs, hide it
      document.getElementById('playerDetail').hidden = true;

      document.getElementById('view-merit').hidden = (v!=='merit');
      document.getElementById('view-breaks').hidden = (v!=='breaks');

      // recalc when returning to merit view (only if auto-fit is on)
      if (v==='merit'){
        const tbl=document.getElementById('playersGrid');
        if (tbl && document.getElementById('chkAutoFit').checked){
          const weeksCount = tbl.querySelectorAll('thead th.col-week').length;
          autoFitWeekWidth(tbl, weeksCount);
        }
      }
    });
  });

  // Recompute on resize (debounced) — only needed when auto-fit is on
  let resizeTimer;
  window.addEventListener('resize', () => {
    if (!document.getElementById('chkAutoFit').checked) return;
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(()=>{
      const tbl=document.getElementById('playersGrid');
      if (!tbl) return;
      const weeksCount = tbl.querySelectorAll('thead th.col-week').length;
      autoFitWeekWidth(tbl, weeksCount);
    }, 100);
  }, { passive:true });

})();
</script>
</body>
</html>
