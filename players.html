<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Players — High Peak & Marple Snooker League</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .tab-btn {
      margin: 0.2em;
      padding: 0.4em 0.8em;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .tab-btn.active { box-shadow: 0 0 0 2px #333 inset; }

    tr.team-color-0 { background-color: #e6f4ff; }
    tr.team-color-1 { background-color: #e6ffe6; }
    tr.team-color-2 { background-color: #fff0e6; }
    tr.team-color-3 { background-color: #f9e6ff; }
    tr.team-color-4 { background-color: #fffde6; }
    tr.team-color-5 { background-color: #f0f0ff; }
    tr.team-color-6 { background-color: #e6fff2; }
    tr.team-color-7 { background-color: #ffe6f0; }
    tr.team-color-8 { background-color: #f6f6f6; }
    tr.team-color-9 { background-color: #e0f7fa; }

    .tab-btn.color-0 { background: #cce8ff; color: #000; }
    .tab-btn.color-1 { background: #bfffbf; color: #000; }
    .tab-btn.color-2 { background: #ffd4b3; color: #000; }
    .tab-btn.color-3 { background: #ebccff; color: #000; }
    .tab-btn.color-4 { background: #fff9b3; color: #000; }
    .tab-btn.color-5 { background: #d6d6ff; color: #000; }
    .tab-btn.color-6 { background: #b3ffe0; color: #000; }
    .tab-btn.color-7 { background: #ffcce0; color: #000; }
    .tab-btn.color-8 { background: #dddddd; color: #000; }
    .tab-btn.color-9 { background: #b2ebf2; color: #000; }

    .table-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; }
    table { width:100%; border-collapse:collapse; }
    thead th { background:#eaeaea; position:sticky; top:0; z-index:1; }
    th, td { padding:.55rem .5rem; border-bottom:1px solid #e6e6e6; text-align:center; white-space:nowrap; }
    th:nth-child(1), td:nth-child(1) { text-align:left; white-space:normal; }
  </style>
</head>
<body>

  <header>
    <h1>High Peak &amp; Marple Snooker League</h1>
  </header>

  <div id="announcement-banner"><span id="announcement-text"></span></div>

  <nav>
    <a href="index.html">Home</a>
    <a href="fixtures.html">Fixtures</a>
    <a href="results.html">Results</a>
    <a href="players.html" class="active">Players</a>
    <a href="venues.html">Venues</a>
    <a href="rules.html">Rules</a>
    <a href="merit.html">Merit</a>
    <a href="history.html">Honours List</a>
    <a href="archive.html">Archive</a>
  </nav>

  <main>
    <h2>Players</h2>
    <p>Toggle a team to view its players. Team colour will match row highlight. Data recalculated from results automatically.</p>

    <div class="tabs" id="teamTabs"></div>

    <div class="table-wrap">
      <table id="playersTable" aria-describedby="playersCaption">
        <caption id="playersCaption">Player statistics & handicaps</caption>
        <thead>
          <tr>
            <th role="button" data-sort="name">Player</th>
            <th>Team</th>
            <th title="Starting handicap">HCP</th>
            <th title="Points at start">P</th>
            <th title="Frames played">FP</th>
            <th title="Frames won">FW</th>
            <th title="Frames lost">FL</th>
            <th title="Frame difference">FD</th>
            <th title="Win % (frames)">Win%</th>
          </tr>
        </thead>
        <tbody id="playersTbody"></tbody>
      </table>
    </div>
  </main>

  <footer>&copy; 2025 High Peak &amp; Marple Snooker League</footer>

  <script>
    // Announcement
    fetch('data/announcement.json')
      .then(r => r.json())
      .then(data => {
        if (data.message && data.message.trim()) {
          document.getElementById('announcement-text').textContent = data.message;
          document.getElementById('announcement-banner').style.display = 'block';
        }
      })
      .catch(err => console.warn('Banner error:', err));
  </script>

  <script>
  (async function() {
    const [teams, players, matches] = await Promise.all([
      fetch('data/teams.json',   {cache:'no-store'}).then(r=>r.json()),
      fetch('data/players.json', {cache:'no-store'}).then(r=>r.json()),
      fetch('data/matches.json', {cache:'no-store'}).then(r=>r.json())
    ]);

    // Maps and colour classes
    const teamById = {};
    const teamColorClass = {};
    teams.forEach((t, i) => {
      teamById[t.id] = t;
      teamColorClass[t.id] = i % 10;
    });

    // Seed player stats object
    const stats = {};
    for (const p of players) {
      stats[p.id] = {
        playerId: p.id, name: p.name, teamId: p.teamId,
        HCP: p.HCP ?? 0, Pstart: p.P ?? 0,
        captain: !!p.captain, change: p.change ?? null,
        FP:0, FW:0, FL:0, FD:0, WinPct:0
      };
    }

    // Compute frame stats from matches.frames[]
    for (const m of matches) {
      if (!Array.isArray(m.frames)) continue;
      for (const fr of m.frames) {
        const h = stats[fr.homePlayerId], a = stats[fr.awayPlayerId];
        if (h) h.FP++;
        if (a) a.FP++;
        if (fr.winner === 'home') { if (h) h.FW++; if (a) a.FL++; }
        if (fr.winner === 'away') { if (a) a.FW++; if (h) h.FL++; }
      }
    }

    for (const s of Object.values(stats)) {
      s.FD = s.FW - s.FL;
      s.WinPct = s.FP ? (100 * s.FW / s.FP) : 0;
    }

    // Tabs
    const tabs = document.getElementById('teamTabs');
    const ALL = '__all__';

    const mkBtn = (id, label, colorClass) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'tab-btn' + (colorClass !== null ? ` color-${colorClass}` : '');
      b.dataset.teamId = id;
      b.textContent = label;
      b.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        render(id);
        localStorage.setItem('playersTeamFilter', id);
        const newUrl = id && id !== ALL ? `?team=${encodeURIComponent(id)}` : location.pathname;
        history.replaceState(null, '', newUrl);
      });
      return b;
    };

    tabs.appendChild(mkBtn(ALL, 'All Teams', null));
    teams.forEach((t) => tabs.appendChild(mkBtn(t.id, t.name, teamColorClass[t.id])));

    // >>> Deep-link support: ?team=<teamId> takes priority <<<
    const urlTeam = new URLSearchParams(location.search).get('team');
    const stored  = localStorage.getItem('playersTeamFilter');
    const startId = (urlTeam && teamById[urlTeam]) ? urlTeam : (stored && teamById[stored] ? stored : ALL);
    const startBtn = [...tabs.children].find(b => b.dataset.teamId === startId) || tabs.firstChild;
    startBtn.click();

    // Click on "Player" header toggles sort-name ascending
    document.querySelector('th[data-sort="name"]').addEventListener('click', () => {
      const current = localStorage.getItem('playersSortAsc') === 'true';
      localStorage.setItem('playersSortAsc', (!current).toString());
      render(document.querySelector('.tab-btn.active')?.dataset.teamId || ALL);
    });

    function render(teamId) {
      const asc = localStorage.getItem('playersSortAsc') === 'true';
      const tb = document.getElementById('playersTbody');
      tb.innerHTML = '';

      const rows = Object.values(stats)
        .filter(s => teamId === ALL || s.teamId === teamId)
        .sort((a, b) => (b.WinPct - a.WinPct) || (b.FW - a.FW) || a.name.localeCompare(b.name));

      if (asc) rows.sort((a, b) => a.name.localeCompare(b.name));

      for (const s of rows) {
        const tag = s.captain ? ' (C)' : '';
        const bump = s.change === 'up' ? ' C+' : (s.change === 'down' ? ' C-' : '');
        const tr = document.createElement('tr');
        tr.className = `team-color-${teamColorClass[s.teamId]}`;
        tr.innerHTML = `
          <td>${escapeHtml(s.name + tag)}</td>
          <td>${escapeHtml(teamById[s.teamId]?.name || '')}</td>
          <td>${s.HCP}${bump}</td>
          <td>${s.Pstart}</td>
          <td>${s.FP}</td>
          <td>${s.FW}</td>
          <td>${s.FL}</td>
          <td>${s.FD}</td>
          <td>${s.WinPct.toFixed(1)}%</td>`;
        tb.appendChild(tr);
      }

      // Optional: reflect team name in document title
      document.title = teamId !== ALL && teamById[teamId]
        ? `Players — ${teamById[teamId].name} — High Peak & Marple`
        : 'Players — High Peak & Marple Snooker League';
    }

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  })();
  </script>
</body>
</html>
